<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AHS Class of ’28 — Announcements</title>
  <meta name="theme-color" content="#0d6efd" />
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* --- Header hardening: consistent layout + reliable mobile menu --- */
    .nav{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .links{ display:flex; align-items:center; gap:16px; flex-wrap:nowrap; white-space:nowrap; }
    .mobile-menu{ z-index:1000; }
    .hidden{ display:none !important; }

    /* Page base */
    body { color: var(--text); background: transparent; overflow-x:hidden; }
    #starfield{ position: fixed; inset:0; z-index:-1; pointer-events:none; display:block; }
    main{ max-width: 1100px; margin: 0 auto; padding: 26px 18px 44px; }

    /* Announcements */
    .ann-list{ display:grid; gap:14px; }
    .ann.card{ padding:16px; }
    .ann-title{ font-weight:900; font-size:1.1rem; margin:0 0 6px; }
    .ann-meta{ font-size:12px; color:var(--muted); margin-bottom:10px; }
    .ann-content p{ margin: 0 0 10px; }

    /* Tools */
    .toolbar{ display:flex; gap:10px; align-items:center; margin:12px 0 18px; }
    .toolbar .input{ max-width:360px; }

    .empty{ text-align:center; opacity:.85; padding:24px 10px; border:1px dashed var(--border); border-radius:14px; }
  </style>
</head>
<body>
  <canvas id="starfield" aria-hidden="true"></canvas>

  <!-- Header / Nav -->
  <header class="header" role="banner">
    <nav class="nav" aria-label="Primary">
      <a class="brand" href="./" aria-label="AHS Class of 2028 — Home">
        <span class="logo" aria-hidden="true">A</span>
        AHS Class of ’28
      </a>
      <div class="links" role="navigation">
        <a href="./index.html">Home</a>
        <a href="./fundraisers.html">Fundraisers</a>
        <a href="./calendar.html">Calendar</a>
        <a href="./media.html">Media</a>
        <a href="./achievements.html">Achievements</a>
        <a href="./about.html">About</a>
        <a href="./contact.html">Contact</a>
        <a href="./shop.html">Shop</a>
        <a class="active" href="./announcements.html">Announcements</a>
        <a href="./community.html">Community</a>
      </div>
      <button id="menuBtn" class="menu-btn" aria-expanded="false" aria-controls="mobileMenu" aria-label="Open menu">☰</button>
    </nav>

    <div id="mobileMenu" class="mobile-menu hidden" role="dialog" aria-modal="true" aria-label="Mobile navigation">
      <a href="./index.html">Home</a>
      <a href="./fundraisers.html">Fundraisers</a>
      <a href="./calendar.html">Calendar</a>
      <a href="./media.html">Media</a>
      <a href="./achievements.html">Achievements</a>
      <a href="./about.html">About</a>
      <a href="./contact.html">Contact</a>
      <a href="./shop.html">Shop</a>
      <a class="active" href="./announcements.html">Announcements</a>
      <a href="./community.html">Community</a>
      <div class="small" style="padding:8px 10px; opacity:.8">Tap outside to close</div>
    </div>
  </header>

  <main>
    <h1>Announcements</h1>

    <!-- simple tools -->
    <div class="toolbar">
      <input id="q" class="input" type="search" placeholder="Search announcements…" aria-label="Search announcements">
    </div>

    <div id="list" class="ann-list"></div>
    <div id="empty" class="empty hidden">No announcements found.</div>
  </main>

  <footer class="footer">
    <div class="container">
      <div class="small">Edit announcements in <code>data/announcements.json</code></div>
    </div>
  </footer>

  <script>
    /* ===== Universal mobile menu (guarded so it never double-binds) ===== */
    (function initMobileMenu(){
      if (window.__ahsMenuBound) return;
      window.__ahsMenuBound = true;

      function bind(){
        const btn  = document.getElementById('menuBtn');
        const menu = document.getElementById('mobileMenu');
        if (!btn || !menu) return;

        let open = false;
        const set = (v)=>{
          open = v;
          menu.classList.toggle('hidden', !open);
          btn.setAttribute('aria-expanded', String(open));
        };

        btn.addEventListener('click', (e)=>{ e.stopPropagation(); set(!open); }, {passive:true});
        document.addEventListener('click', (e)=>{
          if (!open) return;
          if (!menu.contains(e.target) && e.target !== btn) set(false);
        });
        document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') set(false); });
        menu.querySelectorAll('a').forEach(a=> a.addEventListener('click', ()=> set(false)));
        window.addEventListener('hashchange', ()=> set(false));
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', bind, {once:true});
      } else {
        bind();
      }
    })();

    /* Starfield (theme-aware, non-interactive) */
    (function(){
      const cvs = document.getElementById('starfield');
      const ctx = cvs.getContext('2d', { alpha:false });
      let stars=[];
      function resize(){
        cvs.width = innerWidth; cvs.height = innerHeight;
        stars = Array.from({length:200},()=>({
          x:Math.random()*cvs.width, y:Math.random()*cvs.height,
          r:Math.random()*1.6, v:Math.random()*0.3+0.05
        }));
      }
      addEventListener('resize', resize); resize();
      (function tick(){
        const light = document.documentElement.getAttribute('data-theme')==='light';
        const g = ctx.createLinearGradient(0,0,0,cvs.height);
        if(light){ g.addColorStop(0,'#eaf2ff'); g.addColorStop(1,'#ffffff'); }
        else{ g.addColorStop(0,'#0b0e1a'); g.addColorStop(1,'#000'); }
        ctx.fillStyle=g; ctx.fillRect(0,0,cvs.width,cvs.height);
        ctx.fillStyle = light? 'rgba(60,90,140,.85)':'rgba(180,200,255,.85)';
        for(const s of stars){
          ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
          s.y+=s.v; if(s.y>cvs.height){ s.y=-2; s.x=Math.random()*cvs.width; }
        }
        requestAnimationFrame(tick);
      })();
    })();

    /* ===== Announcements loader with search ===== */
    const CANDIDATE_SOURCES = [
      'data/announcements.json',
      '../data/announcements.json'
    ];

    const listEl = document.getElementById('list');
    const emptyEl = document.getElementById('empty');
    const q = document.getElementById('q');
    let ANN = [];

    function mdToHTML(s){
      if(!s) return '';
      let html = s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
      html = html.replace(/\n{2,}/g, '</p><p>');
      html = '<p>'+html.replace(/\n/g,'<br>')+'</p>';
      return html;
    }
    function parseTimeSafe(v){
      if (!v) return -Infinity;
      const t = new Date(v).getTime();
      return Number.isNaN(t) ? -Infinity : t;
    }
    function normalizeItem(raw){
      return {
        title:   raw.title   ?? raw.name    ?? raw.heading ?? '',
        date:    raw.date    ?? raw.posted  ?? raw.published ?? raw.created ?? '',
        content: raw.content ?? raw.body    ?? raw.text    ?? raw.markdown ?? '',
        html:    raw.html    ?? ''
      };
    }

    function render(){
      const term = (q.value || '').toLowerCase().trim();
      const filtered = ANN
        .filter(a => (a.title||a.content||a.html||'').toLowerCase().includes(term))
        .sort((a,b)=> parseTimeSafe(b.date) - parseTimeSafe(a.date));

      listEl.innerHTML = '';
      if (!filtered.length){ emptyEl.classList.remove('hidden'); return; }
      emptyEl.classList.add('hidden');

      for (const a of filtered){
        const card = document.createElement('article');
        card.className = 'card hover-up ann';

        const title = document.createElement('h3');
        title.className = 'ann-title';
        title.textContent = a.title || 'Untitled';

        const meta = document.createElement('div');
        meta.className = 'ann-meta';
        const t = parseTimeSafe(a.date);
        meta.textContent = Number.isFinite(t) ? new Date(t).toLocaleDateString() : (a.date || '');

        const body = document.createElement('div');
        body.className = 'ann-content';
        body.innerHTML = a.html ? a.html : mdToHTML(a.content || '');

        card.appendChild(title);
        card.appendChild(meta);
        card.appendChild(body);
        listEl.appendChild(card);
      }
    }

    function showError(msg){
      emptyEl.classList.remove('hidden');
      emptyEl.textContent = 'Announcements error: ' + msg;
    }

    async function fetchFirst(urls){
      for (const path of urls){
        try{
          const res = await fetch(path + '?ts=' + Date.now(), { cache: 'no-store' });
          if(res.ok) return await res.text();
        }catch(_) {}
      }
      throw new Error('Could not load announcements.json from expected paths.');
    }

    (async function load(){
      try{
        const text = await fetchFirst(CANDIDATE_SOURCES);
        let data;
        try { data = JSON.parse(text); }
        catch{ showError('JSON parse error — check commas/brackets'); return; }

        if(Array.isArray(data)) ANN = data.map(normalizeItem);
        else if (data && Array.isArray(data.items)) ANN = data.items.map(normalizeItem);
        else { showError('JSON must be an array: [ {title,date,content}, ... ]'); return; }

        ANN = ANN.filter(a => a && (a.title || a.content || a.html));
        render();

        // Debounced search
        let id; q.addEventListener('input', ()=>{ clearTimeout(id); id=setTimeout(render, 120); });
      }catch(err){
        showError(err.message || 'Unknown error');
      }
    })();
  </script>

  <script src="script.js?v=27" defer></script>
</body>
</html>
