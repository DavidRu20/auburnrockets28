<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AHS Class of ’28 — Announcements</title>
  <meta name="theme-color" content="#0d6efd" />
  <link rel="stylesheet" href="styles.css?v=28" />
  <style>
    body { color: var(--text); background: transparent; overflow-x:hidden; }
    #starfield{ position: fixed; inset:0; z-index:-1; }
    main{ max-width: 1100px; margin: 0 auto; padding: 26px 18px 44px; }
    .ann-list{ display:grid; gap:14px; }
    .ann.card{ padding:16px; }
    .ann-title{ font-weight:900; font-size:1.1rem; margin:0 0 6px; }
    .ann-meta{ font-size:12px; color:var(--muted); margin-bottom:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .ann-content p{ margin: 0 0 10px; }
    .toolbar{ display:flex; gap:10px; align-items:center; margin:12px 0 18px; flex-wrap:wrap; }
    .toolbar .input{ max-width:360px; }
    .tool-spacer{ flex:1 1 auto; }
    .empty{ text-align:center; opacity:.85; padding:24px 10px; border:1px dashed var(--border); border-radius:14px; }
    .link-btn{ font-size:12px; opacity:.9; text-decoration:underline; }
  </style>
</head>
<body>
  <canvas id="starfield"></canvas>

  <!-- Header / Nav -->
  <header class="header" role="banner">
    <nav class="nav" aria-label="Primary">
      <a class="brand" href="./" aria-label="AHS Class of 2028 — Home">
        <span class="logo" aria-hidden="true">A</span>
        AHS Class of ’28
      </a>
      <div class="links" role="navigation">
        <a href="./">Home</a>
        <a href="./fundraisers.html">Fundraisers</a>
        <a href="./calendar.html">Calendar</a>
        <a href="./media.html">Media</a>
        <a href="./achievements.html">Achievements</a>
        <a href="./about.html">About</a>
        <a href="./contact.html">Contact</a>
        <a href="./shop.html">Shop</a>
        <a class="active" href="./announcements.html">Announcements</a>
        <a href="./community.html">Community</a>
      </div>
      <button id="menuBtn" class="menu-btn" aria-expanded="false" aria-controls="mobileMenu" aria-label="Open menu">☰</button>
    </nav>
    <div id="mobileMenu" class="mobile-menu hidden" role="dialog" aria-modal="true" aria-label="Mobile navigation">
      <a href="./">Home</a>
      <a href="./fundraisers.html">Fundraisers</a>
      <a href="./calendar.html">Calendar</a>
      <a href="./media.html">Media</a>
      <a href="./achievements.html">Achievements</a>
      <a href="./about.html">About</a>
      <a href="./contact.html">Contact</a>
      <a href="./shop.html">Shop</a>
      <a class="active" href="./announcements.html">Announcements</a>
      <a href="./community.html">Community</a>
      <div class="small" style="padding:8px 10px; opacity:.8">Tap outside to close</div>
    </div>
  </header>

  <main>
    <h1>Announcements</h1>

    <!-- Subscribe + Search toolbar -->
    <div class="toolbar">
      <a class="btn" href="./contact.html?subject=Subscribe%20me%20to%20Announcements">Email me updates</a>
      <button id="dlIcs" class="btn primary" type="button">Download iCal (.ics)</button>
      <div class="tool-spacer"></div>
      <input id="q" class="input" type="search" placeholder="Search announcements…" aria-label="Search announcements">
    </div>

    <div id="list" class="ann-list"></div>
    <div id="empty" class="empty hidden">No announcements found.</div>
  </main>

  <footer class="footer">
    <div class="container">
      <div class="small">Edit announcements in <code>data/announcements.json</code></div>
    </div>
  </footer>

  <script>
    /* Mobile menu */
    (function(){
      const btn = document.getElementById('menuBtn');
      const menu = document.getElementById('mobileMenu');
      if (!btn || !menu) return;
      btn.addEventListener('click', e=>{
        e.stopPropagation();
        const hidden = menu.classList.toggle('hidden');
        btn.setAttribute('aria-expanded', String(!hidden));
      });
      document.addEventListener('click', e=>{
        if (!menu.classList.contains('hidden') && !menu.contains(e.target) && e.target !== btn){
          btn.setAttribute('aria-expanded','false'); menu.classList.add('hidden');
        }
      });
    })();

    /* Starfield */
    (function(){
      const cvs = document.getElementById('starfield');
      const ctx = cvs.getContext('2d', { alpha:false });
      let stars=[];
      function resize(){ cvs.width=innerWidth; cvs.height=innerHeight;
        stars = Array.from({length:200},()=>({x:Math.random()*cvs.width,y:Math.random()*cvs.height,r:Math.random()*1.6,v:Math.random()*0.3+0.05}));
      }
      addEventListener('resize', resize); resize();
      (function tick(){
        const light = document.documentElement.getAttribute('data-theme')==='light';
        const g = ctx.createLinearGradient(0,0,0,cvs.height);
        if(light){ g.addColorStop(0,'#eaf2ff'); g.addColorStop(1,'#ffffff'); }
        else{ g.addColorStop(0,'#0b0e1a'); g.addColorStop(1,'#000'); }
        ctx.fillStyle=g; ctx.fillRect(0,0,cvs.width,cvs.height);
        ctx.fillStyle = light? 'rgba(60,90,140,.85)':'rgba(180,200,255,.85)';
        for(const s of stars){ ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill(); s.y+=s.v; if(s.y>cvs.height){ s.y=-2; s.x=Math.random()*cvs.width; } }
        requestAnimationFrame(tick);
      })();
    })();

    /* Announcements loader */
    const SOURCE = 'data/announcements.json';
    const listEl = document.getElementById('list');
    const emptyEl = document.getElementById('empty');
    const q = document.getElementById('q');
    const dlIcsBtn = document.getElementById('dlIcs');
    let ANN = [];

    function mdToHTML(s){
      if(!s) return '';
      let html = s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
      html = html.replace(/\n{2,}/g, '</p><p>');
      html = '<p>'+html.replace(/\n/g,'<br>')+'</p>';
      return html;
    }

    function render(){
      const term = (q.value||'').toLowerCase().trim();
      const filtered = ANN.filter(a=>{
        const hay = (a.title+' '+a.content).toLowerCase();
        return !term || hay.includes(term);
      }).sort((a,b)=> b.date.localeCompare(a.date)); // newest first

      listEl.innerHTML = '';
      if (!filtered.length){ emptyEl.classList.remove('hidden'); return; }
      emptyEl.classList.add('hidden');

      filtered.forEach(a=>{
        const card = document.createElement('article');
        card.className = 'card hover-up ann';

        const title = document.createElement('h3');
        title.className = 'ann-title';
        title.textContent = a.title || 'Untitled';

        const meta = document.createElement('div');
        meta.className = 'ann-meta';
        const dt = new Date(a.date);
        const dateText = isFinite(dt) ? dt.toLocaleDateString() : (a.date||'');
        meta.textContent = dateText;

        // per-announcement "Add to calendar" (single .ics)
        const addCal = document.createElement('a');
        addCal.href = '#';
        addCal.className = 'link-btn';
        addCal.textContent = 'Add to calendar';
        addCal.addEventListener('click', (e)=>{ e.preventDefault(); downloadSingleICS(a); });

        // put the link next to the date
        meta.appendChild(document.createTextNode(' • '));
        meta.appendChild(addCal);

        const body = document.createElement('div');
        body.className = 'ann-content';
        body.innerHTML = mdToHTML(a.content || '');

        card.appendChild(title);
        card.appendChild(meta);
        card.appendChild(body);
        listEl.appendChild(card);
      });
    }

    // --- iCal helpers ---
    function icsEscape(s=''){
      return String(s)
        .replace(/\\/g,'\\\\')
        .replace(/\n/g,'\\n')
        .replace(/,/g,'\\,')
        .replace(/;/g,'\\;');
    }
    function ymd(dateStr){
      // expects YYYY-MM-DD; returns YYYYMMDD
      const m = String(dateStr||'').match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(!m) return '';
      return `${m[1]}${m[2]}${m[3]}`;
    }
    function nowUTC(){
      const d = new Date();
      const YYYY = d.getUTCFullYear();
      const MM = String(d.getUTCMonth()+1).padStart(2,'0');
      const DD = String(d.getUTCDate()).padStart(2,'0');
      const hh = String(d.getUTCHours()).padStart(2,'0');
      const mm = String(d.getUTCMinutes()).padStart(2,'0');
      const ss = String(d.getUTCSeconds()).padStart(2,'0');
      return `${YYYY}${MM}${DD}T${hh}${mm}${ss}Z`;
    }
    function buildVEVENT(a, idx=0){
      const dt = ymd(a.date||'');
      const uid = `${dt}-${idx}@ahs-class-of-28`;
      const summary = icsEscape(a.title || 'Announcement');
      const desc = icsEscape((a.content||'').replace(/\n{3,}/g,'\n\n'));
      const url = location.href; // page URL
      // All-day event (DTSTART only). If you want a 1-hour block, add DTEND: YYYYMMDDT...
      return [
        'BEGIN:VEVENT',
        `UID:${uid}`,
        `DTSTAMP:${nowUTC()}`,
        dt ? `DTSTART;VALUE=DATE:${dt}` : '',
        `SUMMARY:${summary}`,
        desc ? `DESCRIPTION:${desc}` : '',
        `URL:${url}`,
        'END:VEVENT'
      ].filter(Boolean).join('\r\n');
    }
    function buildICS(list){
      const vevents = list.map(buildVEVENT);
      return [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//AHS Class of 28//Announcements//EN',
        'CALSCALE:GREGORIAN',
        'METHOD:PUBLISH',
        ...vevents,
        'END:VCALENDAR'
      ].join('\r\n');
    }
    function downloadBlob(filename, text){
      const blob = new Blob([text], {type: 'text/calendar;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    }
    function downloadAllICS(){
      if(!ANN.length){ alert('No announcements to export yet.'); return; }
      const ics = buildICS(ANN);
      downloadBlob('ahs-announcements.ics', ics);
    }
    function downloadSingleICS(a){
      const ics = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//AHS Class of 28//Announcements//EN',
        'CALSCALE:GREGORIAN',
        'METHOD:PUBLISH',
        buildVEVENT(a, 1),
        'END:VCALENDAR'
      ].join('\r\n');
      const safe = (a.title||'announcement').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
      downloadBlob(`${safe || 'announcement'}.ics`, ics);
    }

    // wire up buttons
    dlIcsBtn.addEventListener('click', downloadAllICS);
    q.addEventListener('input', render);

    // load JSON + render
    fetch(SOURCE, { cache:'no-store' })
      .then(r=> r.ok ? r.json() : [])
      .then(data => { ANN = Array.isArray(data) ? data : []; render(); })
      .catch(()=>{ ANN = []; render(); });
  </script>

  <script src="script.js?v=28"></script>
</body>
</html>

