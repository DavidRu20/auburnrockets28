<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rocket Clicker â€” Launch Lab</title>
<style>
  :root{
    --bg1: #071229; --bg2:#031022; --panel:rgba(255,255,255,0.03);
    --accent:#ff7a18; --muted:#9fb0c8;
    --card-radius:14px;
  }
  *{box-sizing:border-box;font-family:Inter,Segoe UI,system-ui,Arial,Helvetica,sans-serif}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--sky-top,#0b2340),var(--sky-bottom,#031022));color:#e6f3ff}
  .app{display:grid;grid-template-columns:1fr 360px;gap:22px;max-width:1200px;margin:18px auto;padding:18px}
  header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:20px}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:var(--card-radius);padding:16px;box-shadow:0 8px 30px rgba(0,0,0,0.5)}
  .left{padding:18px}
  .sky{height:560px;border-radius:12px;padding:20px;position:relative;overflow:hidden;background:transparent}
  .stars, .stars .star{position:absolute;pointer-events:none}
  .star{width:2px;height:2px;border-radius:50%;background:rgba(255,255,255,0.8);filter:blur(0.4px);opacity:0.9}
  /* slow downward movement for parallax */
  .star { animation: drift var(--drift-speed,60s) linear infinite; }
  @keyframes drift { from { transform: translateY(-6vh); } to { transform: translateY(6vh); } }

  .rocket-wrap{position:absolute;left:50%;transform:translateX(-50%) translateY(0);bottom:8%;transition:transform 0.6s cubic-bezier(.2,.9,.2,1)}
  .rocket-stage{position:absolute;left:50%;transform:translateX(-50%);bottom:0;opacity:0;transition:opacity 320ms ease, transform 320ms ease}
  .rocket-stage.active{opacity:1;transform:translateX(-50%) translateY(0)}
  .rocket{width:160px;height:260px;display:block;user-select:none;cursor:pointer}
  .flame{position:absolute;left:50%;transform:translateX(-50%);bottom:-18px;width:56px;height:90px;filter:drop-shadow(0 12px 20px rgba(255,120,30,0.2));transition:transform 120ms}
  .flame svg g{transform-origin:50% 0%; animation: flame-flicker 0.14s infinite;}
  @keyframes flame-flicker{0%{transform:scaleY(.96)}50%{transform:scaleY(1.18)}100%{transform:scaleY(1)}}
  .rocket-idle{animation: idle-sway 3.6s ease-in-out infinite}
  @keyframes idle-sway{0%{transform:translateX(-50%) translateY(0) rotate(-1deg)}50%{transform:translateX(-50%) translateY(-6px) rotate(1deg)}100%{transform:translateX(-50%) translateY(0) rotate(-1deg)}}

  .hud{margin-top:8px;display:flex;gap:12px;align-items:center}
  .fuel-counter{font-weight:800;font-size:20px}
  .muted{color:var(--muted);font-size:13px}
  .shop{display:flex;flex-direction:column;gap:12px}
  .store-list{max-height:420px;overflow:auto;padding-right:6px}
  .item{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);cursor:pointer;transition:transform .12s}
  .item:hover{transform:translateY(-4px)}
  .item.locked{opacity:0.42;cursor:not-allowed;transform:none}
  .name{font-weight:700}
  .num{color:var(--muted)}
  button{background:linear-gradient(180deg,#103042,#0b2436);border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:#cfeefb;cursor:pointer}
  footer{grid-column:1/-1;margin-top:8px;text-align:center;color:var(--muted);font-size:13px}

  /* sparkles */
  .sparkle{position:absolute;width:8px;height:8px;border-radius:50%;background:linear-gradient(90deg,#fff,#ffd7b3);pointer-events:none;filter:blur(0.6px)}
  /* shooting stars */
  .shoot{position:absolute;width:4px;height:4px;border-radius:50%;background:linear-gradient(90deg,#fff,#ffd7b3);box-shadow:0 0 8px rgba(255,220,160,0.95);pointer-events:none}
  /* particles (exhaust) */
  .particle{position:absolute;border-radius:50%;pointer-events:none;opacity:0.9}

  /* locked overlay text */
  .locked-tag{font-size:12px;color:#ffd7b3;background:rgba(0,0,0,0.24);padding:4px 8px;border-radius:8px}

  @media (max-width:920px){.app{grid-template-columns:1fr;}.sky{height:420px}}
</style>
</head>
<body>
  <div class="app">
    <header>
      <h1>ðŸš€ Rocket Clicker â€” Launch Lab</h1>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="muted">Fuel: <span id="fuelTop">0</span></div>
        <button id="saveBtn">Save</button>
        <button id="resetBtn">Reset</button>
      </div>
    </header>

    <main class="left panel">
      <div class="sky" id="sky">
        <div id="starField" class="stars"></div>

        <!-- Rocket wrapper: contains multiple stage SVGs that we fade in/out -->
        <div class="rocket-wrap" id="rocketWrap">
          <!-- Base rocket (stage 0) -->
          <div class="rocket-stage" id="stage-0">
            <div id="rocket0" class="rocket rocket-idle" role="button" title="Click (or press Space)">
              <svg viewBox="0 0 120 200" width="160" height="260">
                <defs>
                  <linearGradient id="b0" x1="0" x2="0" y1="0" y2="1">
                    <stop offset="0%" stop-color="#eef7ff" stop-opacity="0.98"/>
                    <stop offset="100%" stop-color="#cfeefb" stop-opacity="0.06"/>
                  </linearGradient>
                </defs>
                <g transform="translate(10,8)">
                  <ellipse cx="50" cy="160" rx="22" ry="8" fill="#071822" opacity="0.12"/>
                  <rect x="28" y="30" width="44" height="110" rx="18" fill="url(#b0)" stroke="#7fd4ff" stroke-opacity="0.08"/>
                  <path d="M50 2 C40 18,62 18,50 2 Z" fill="#ff8c4a" opacity="0.95"/>
                  <circle cx="50" cy="72" r="10" fill="#082632" stroke="#7fd4ff" stroke-opacity="0.08"/>
                  <path d="M26 96 L6 130 L26 106 Z" fill="#0f2740" opacity="0.95"/>
                  <path d="M74 96 L94 130 L74 106 Z" fill="#0f2740" opacity="0.95"/>
                </g>
              </svg>
            </div>
            <div class="flame" id="flame0">
              <svg viewBox="0 0 40 60" width="56" height="90">
                <g>
                  <path d="M20 2 C10 18,6 30,20 54 C34 30,30 18,20 2 Z" fill="#ffb84d" opacity="0.95"/>
                  <path d="M20 8 C14 22,12 30,20 46 C28 30,26 22,20 8 Z" fill="#ff7a18" opacity="0.95"/>
                </g>
              </svg>
            </div>
          </div>

          <!-- Mk II -->
          <div class="rocket-stage" id="stage-1">
            <div id="rocket1" class="rocket rocket-idle" title="Mk II">
              <svg viewBox="0 0 140 220" width="180" height="300">
                <defs>
                  <linearGradient id="b1" x1="0" x2="0" y1="0" y2="1">
                    <stop offset="0%" stop-color="#fff6f0" stop-opacity="0.95"/>
                    <stop offset="100%" stop-color="#ffd7b3" stop-opacity="0.06"/>
                  </linearGradient>
                </defs>
                <g transform="translate(10,4)">
                  <ellipse cx="60" cy="180" rx="28" ry="10" fill="#071822" opacity="0.12"/>
                  <rect x="36" y="30" width="58" height="120" rx="18" fill="url(#b1)" stroke="#ffb874" stroke-opacity="0.08"/>
                  <path d="M65 2 C50 26,80 26,65 2 Z" fill="#ff4a6b" />
                  <circle cx="65" cy="86" r="12" fill="#081827" stroke="#ffd7b3" stroke-opacity="0.12"/>
                  <path d="M34 110 L8 150 L34 124 Z" fill="#122e46" />
                  <path d="M96 110 L122 150 L96 124 Z" fill="#122e46" />
                  <!-- twin boosters -->
                  <rect x="18" y="90" width="14" height="50" rx="6" fill="#0b2230"/>
                  <rect x="110" y="90" width="14" height="50" rx="6" fill="#0b2230"/>
                </g>
              </svg>
            </div>
            <div class="flame" id="flame1">
              <svg viewBox="0 0 44 70" width="66" height="110">
                <g>
                  <path d="M22 2 C10 22,8 36,22 60 C36 36,34 22,22 2 Z" fill="#ffd7a6"/>
                  <path d="M22 10 C16 26,14 36,22 52 C30 36,28 26,22 10 Z" fill="#ff7a18"/>
                </g>
              </svg>
            </div>
          </div>

          <!-- Mk III -->
          <div class="rocket-stage" id="stage-2">
            <div id="rocket2" class="rocket rocket-idle" title="Mk III">
              <svg viewBox="0 0 160 240" width="200" height="340">
                <defs>
                  <linearGradient id="b2" x1="0" x2="0" y1="0" y2="1">
                    <stop offset="0%" stop-color="#f7fbff" />
                    <stop offset="100%" stop-color="#dff6ff" stop-opacity="0.06"/>
                  </linearGradient>
                </defs>
                <g transform="translate(12,6)">
                  <ellipse cx="70" cy="200" rx="34" ry="12" fill="#071822" opacity="0.12"/>
                  <rect x="40" y="28" width="60" height="128" rx="18" fill="url(#b2)" stroke="#aef0ff" stroke-opacity="0.08"/>
                  <path d="M70 2 C52 30,88 30,70 2 Z" fill="#8a7dff" />
                  <circle cx="70" cy="86" r="14" fill="#041827" stroke="#bceeff" stroke-opacity="0.12"/>
                  <!-- advanced fins & lights -->
                  <path d="M36 116 L6 160 L36 132 Z" fill="#0f2f40"/>
                  <path d="M104 116 L134 160 L104 132 Z" fill="#0f2f40"/>
                  <rect x="22" y="70" width="8" height="20" rx="3" fill="#ffd7b3"/>
                  <rect x="130" y="70" width="8" height="20" rx="3" fill="#ffd7b3"/>
                </g>
              </svg>
            </div>
            <div class="flame" id="flame2">
              <svg viewBox="0 0 48 78" width="72" height="120">
                <g>
                  <path d="M24 2 C12 26,10 44,24 70 C38 44,36 26,24 2 Z" fill="#fff1d6"/>
                  <path d="M24 12 C18 30,16 40,24 60 C32 40,30 30,24 12 Z" fill="#ff7a18"/>
                </g>
              </svg>
            </div>
          </div>

          <!-- Late-game variant (one of several will be chosen) -->
          <div class="rocket-stage" id="stage-late">
            <div id="rocketLate" class="rocket rocket-idle" title="Late Game">
              <svg viewBox="0 0 180 260" width="210" height="360">
                <defs>
                  <linearGradient id="bl" x1="0" x2="0" y1="0" y2="1">
                    <stop offset="0%" stop-color="#fff7ff"/>
                    <stop offset="100%" stop-color="#f0f8ff" stop-opacity="0.05"/>
                  </linearGradient>
                </defs>
                <g transform="translate(10,6)">
                  <ellipse cx="80" cy="220" rx="40" ry="14" fill="#071822" opacity="0.12"/>
                  <rect x="48" y="28" width="64" height="150" rx="20" fill="url(#bl)" stroke="#ffd7b3" stroke-opacity="0.06"/>
                  <path d="M80 2 C58 34,102 34,80 2 Z" fill="#ffd37a"/>
                  <circle cx="80" cy="96" r="16" fill="#021827" stroke="#fff1d6" stroke-opacity="0.12"/>
                  <!-- solar panels -->
                  <rect x="8" y="100" width="30" height="60" rx="3" fill="#0b2a40"/>
                  <rect x="142" y="100" width="30" height="60" rx="3" fill="#0b2a40"/>
                  <!-- big boosters -->
                  <rect x="32" y="80" width="18" height="70" rx="8" fill="#0d2b3f"/>
                  <rect x="130" y="80" width="18" height="70" rx="8" fill="#0d2b3f"/>
                </g>
              </svg>
            </div>
            <div class="flame" id="flameLate">
              <svg viewBox="0 0 60 100" width="90" height="150">
                <g>
                  <path d="M30 2 C12 36,10 60,30 96 C50 60,48 36,30 2 Z" fill="#fff3dd"/>
                  <path d="M30 14 C22 34,20 48,30 76 C40 48,38 34,30 14 Z" fill="#ff6b18"/>
                </g>
              </svg>
            </div>
          </div>

        </div>

        <!-- dynamic particles container -->
        <div id="fxLayer" style="position:absolute;inset:0;pointer-events:none"></div>
      </div>

      <div class="hud panel" style="margin-top:12px;display:flex;align-items:center;justify-content:space-between">
        <div>
          <div class="fuel-counter" id="fuel">0</div>
          <div class="muted small">fuel units</div>
        </div>
        <div style="text-align:right">
          <div class="muted small">Per Click: <span id="perClick">1</span></div>
          <div class="muted small">Per Second: <span id="perSecond">0</span></div>
        </div>
      </div>
    </main>

    <aside class="panel">
      <h3 style="margin-top:0">Launch Bay â€” Shop</h3>
      <div class="muted small">Autoclickers = <strong>Engineers</strong>. Click boosts = <strong>Thrusters</strong>. Research Labs = multipliers.</div>
      <div style="height:12px"></div>
      <div class="shop">
        <div class="store-list panel" id="storeList"></div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div class="muted small">Rocket Altitude</div>
          <div id="altitude" class="fuel-counter">0%</div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div class="muted small">Prestige</div>
          <div id="prestigeWrap"><button id="prestigeBtn" style="display:none">Prestige (1,000,000)</button></div>
        </div>
      </div>
    </aside>

    <footer class="muted small">Tip: Press <strong>Space</strong> to fire a click. Rocket visuals change with fuel milestones.</footer>
  </div>

<script>
/* ---------- Game state ---------- */
const state = {
  fuel: 0,
  perClick: 1,
  perSecond: 0,
  lastTick: Date.now(),
  lastClickTime: 0,
  clickBurstCount: 0,
  prestige: 0,
  // shop items in progression order; unlocking requires owning previous item
  items: [
    { id:'engineer', name:'Engineer', desc:'Skilled engineers automate clicks.', baseCost:15, cps:0.2, cpc:0, qty:0 },
    { id:'thruster', name:'Thruster', desc:'Boosts each manual click.', baseCost:45, cps:0, cpc:1, qty:0 },
    { id:'lab', name:'Research Lab', desc:'Increases thruster efficiency (multiplies clicks).', baseCost:120, cps:0, cpc:0, qty:0, type:'mult', mult:1.5 },
    { id:'sat', name:'Satellite Relay', desc:'Adds passive fuel via remote sensors.', baseCost:650, cps:5, cpc:0, qty:0 },
    { id:'factory', name:'Factory', desc:'Mass-produce components, big passive boost.', baseCost:4000, cps:25, cpc:0, qty:0 }
  ]
};

/* ---------- Utility ---------- */
function fmt(n){
  if(n < 1000) return Math.round(n*100)/100;
  const si=['','K','M','B','T','Qa','Qi','Sx'];
  let i=0; while(n>=1000 && i<si.length-1){ n/=1000; i++; }
  return (Math.round(n*100)/100) + si[i];
}
function now(){ return Date.now(); }

/* ---------- DOM ---------- */
const fuelEl = document.getElementById('fuel');
const fuelTopEl = document.getElementById('fuelTop');
const perClickEl = document.getElementById('perClick');
const perSecondEl = document.getElementById('perSecond');
const storeList = document.getElementById('storeList');
const rocketWrap = document.getElementById('rocketWrap');
const fxLayer = document.getElementById('fxLayer');
const altitudeEl = document.getElementById('altitude');
const prestigeBtn = document.getElementById('prestigeBtn');

/* ---------- Shop helpers ---------- */
function itemCost(item){
  return Math.ceil(item.baseCost * Math.pow(1.14, item.qty));
}
function copyAndSortItemsByCost(){
  // return shallow copy sorted by computed cost (cheapest first)
  return state.items.map(it=>({ ...it, currentCost: itemCost(it) })).sort((a,b)=>a.currentCost - b.currentCost);
}
function isUnlocked(itemIndex){
  if(itemIndex === 0) return true;
  return state.items[itemIndex-1].qty > 0;
}

/* ---------- Recalc & render ---------- */
function recalc(){
  let pc = 1; // base click
  let ps = 0;
  state.items.forEach(it=>{
    if(it.cpc) pc += it.cpc * it.qty;
    if(it.cps) ps += it.cps * it.qty;
    if(it.type === 'mult' && it.qty > 0){
      pc *= Math.pow(it.mult, it.qty);
    }
  });
  state.perClick = pc;
  state.perSecond = ps;
}
function renderStore(){
  // show sorted by current cost but indicate locked items
  const sorted = copyAndSortItemsByCost();
  storeList.innerHTML = '';
  sorted.forEach(si=>{
    const originalIndex = state.items.findIndex(x=>x.id === si.id);
    const unlocked = isUnlocked(originalIndex);
    const el = document.createElement('div');
    el.className = 'item' + (unlocked? '' : ' locked');
    el.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center">
        <div>
          <div class="name">${si.name}</div>
          <div class="muted small">${si.desc}</div>
        </div>
      </div>
      <div style="text-align:right">
        <div class="num">${ unlocked ? fmt(si.currentCost) : '<span class="locked-tag">Locked</span>' }</div>
        <div class="muted small">Owned: ${si.qty}</div>
      </div>
    `;
    el.addEventListener('click', ()=>{
      if(!unlocked) { lockedClickFeedback(); return; }
      buyItem(si.id);
    });
    storeList.appendChild(el);
  });
}
function renderUI(){
  fuelEl.textContent = fmt(state.fuel);
  fuelTopEl.textContent = Math.round(state.fuel);
  perClickEl.textContent = fmt(state.perClick);
  perSecondEl.textContent = fmt(state.perSecond);

  // altitude: simple mapping to percent
  const alt = Math.min(99, Math.sqrt(state.fuel / (1200 + state.prestige*300)) * 100);
  altitudeEl.textContent = Math.round(alt) + '%';
  // rocket vertical shift based on altitude
  rocketWrap.style.transform = `translateX(-50%) translateY(${-(alt/1.6)}px)`;

  renderStore();
  applyRocketStage(); // update rocket visuals & sky
  // prestige button visibility
  if(state.fuel >= 1_000_000) prestigeBtn.style.display = 'inline-block'; else prestigeBtn.style.display = 'none';
}

/* ---------- Shop purchase ---------- */
function buyItem(id){
  const it = state.items.find(x=>x.id===id);
  const cost = itemCost(it);
  if(state.fuel >= cost){
    state.fuel -= cost;
    it.qty++;
    recalc();
    spawnPopup(`Purchased ${it.name}`);
    spawnSparkles(40);
    renderUI();
  } else {
    lockedClickFeedback();
  }
}
function lockedClickFeedback(){
  // small nudge animation to indicate locked
  rocketWrap.style.transition = 'transform 0.08s';
  rocketWrap.style.transform = 'translateX(-50%) translateY(-8px)';
  setTimeout(()=>{ rocketWrap.style.transform = 'translateX(-50%)'; }, 120);
  setTimeout(()=>{ rocketWrap.style.transition = ''; }, 220);
}

/* ---------- Clicks & particles ---------- */
function doClick(n=1){
  state.lastClickTime = now();
  state.clickBurstCount++;
  // fuel increment
  state.fuel += state.perClick * n;
  animateClick();
  spawnExhaustBurst();
  renderUI();
}
function animateClick(){
  // quick scale of active rocket stage flame and idle sway bump
  const active = document.querySelector('.rocket-stage.active .rocket');
  if(active){
    active.classList.add('clicking');
    setTimeout(()=> active.classList.remove('clicking'), 140);
  }
  // flame scale handled in updateFlame()
  updateFlameIntensity();
}
function spawnPopup(text){
  const sky = document.getElementById('sky');
  const el = document.createElement('div');
  el.textContent = text;
  el.style.position = 'absolute';
  el.style.left = (50 + (Math.random()*24-12)) + '%';
  el.style.top = (30 + (Math.random()*10-5)) + '%';
  el.style.transform = 'translate(-50%,-50%)';
  el.style.color = '#ffd7b3';
  el.style.fontWeight = '800';
  el.style.pointerEvents = 'none';
  el.style.userSelect = 'none';
  el.style.opacity = 1;
  el.style.zIndex = 999;
  sky.appendChild(el);
  let t=0;
  const iv = setInterval(()=>{
    t += 16;
    el.style.top = (30 - t/120) + '%';
    el.style.opacity = 1 - t/900;
    if(t > 900){ clearInterval(iv); el.remove(); }
  }, 16);
}
function spawnSparkles(count=12){
  for(let i=0;i<count;i++){
    const sp = document.createElement('div');
    sp.className = 'sparkle';
    sp.style.left = (50 + (Math.random()*30-15)) + '%';
    sp.style.bottom = (8 + (Math.random()*6)) + '%';
    sp.style.width = (6 + Math.random()*8) + 'px';
    sp.style.height = sp.style.width;
    fxLayer.appendChild(sp);
    const dx = (Math.random()*120-60);
    const dy = (80 + Math.random()*80);
    sp.animate([
      { transform: 'translate(0,0) scale(1)', opacity: 1 },
      { transform: `translate(${dx}px, -${dy}px) scale(0.6)`, opacity: 0 }
    ], { duration: 600 + Math.random()*400, easing:'cubic-bezier(.2,.9,.2,1)' });
    setTimeout(()=> sp.remove(), 1200);
  }
}
function spawnExhaustBurst(){
  const rx = rocketWrap.getBoundingClientRect().left + rocketWrap.offsetWidth/2;
  const ry = rocketWrap.getBoundingClientRect().top + rocketWrap.offsetHeight - 30;
  const layerRect = fxLayer.getBoundingClientRect();
  for(let i=0;i<10;i++){
    const p = document.createElement('div');
    p.className = 'particle';
    const size = 6 + Math.random()*8;
    p.style.width = p.style.height = size + 'px';
    p.style.left = (rx - layerRect.left + (Math.random()*40-20)) + 'px';
    p.style.top = (ry - layerRect.top + (Math.random()*20-10)) + 'px';
    p.style.background = `radial-gradient(circle,#ffd9b3, rgba(255,120,30,0.6))`;
    fxLayer.appendChild(p);
    const angle = Math.PI + (Math.random()-0.5) * 1.2;
    const dist = 40 + Math.random()*100;
    const dx = Math.cos(angle) * dist;
    const dy = Math.sin(angle) * dist;
    p.animate([
      { transform: 'translate(0,0) scale(1)', opacity:1 },
      { transform: `translate(${dx}px, ${dy}px) scale(0.3)`, opacity:0 }
    ], { duration: 500 + Math.random()*400, easing: 'cubic-bezier(.2,.9,.2,1)' });
    setTimeout(()=> p.remove(), 1000);
  }
}

/* ---------- SAVE / LOAD ---------- */
function save(){
  try{
    const s = {
      fuel: state.fuel,
      prestige: state.prestige,
      items: state.items.map(it=>({ id: it.id, qty: it.qty }))
    };
    localStorage.setItem('rocket_save_v2', JSON.stringify(s));
    spawnPopup('Saved');
  }catch(e){ console.error(e); }
}
function load(){
  try{
    const s = JSON.parse(localStorage.getItem('rocket_save_v2') || 'null');
    if(!s) return;
    state.fuel = s.fuel || 0;
    state.prestige = s.prestige || 0;
    if(s.items && Array.isArray(s.items)){
      s.items.forEach(si=>{
        const it = state.items.find(x=>x.id===si.id);
        if(it) it.qty = si.qty || 0;
      });
    }
    recalc();
    renderUI();
    spawnPopup('Loaded');
  }catch(e){ console.error(e); }
}

/* ---------- TICK / PASSIVE INCOME ---------- */
function tick(){
  const nowMs = now();
  const dt = (nowMs - state.lastTick) / 1000;
  state.lastTick = nowMs;
  if(state.perSecond > 0){
    state.fuel += state.perSecond * dt;
  }
  // decay click burst count slightly (used to make flame bigger when rapid clicking)
  state.clickBurstCount = Math.max(0, state.clickBurstCount - dt*8);
  updateFlameIntensity();
  renderUI();
}

/* ---------- Rocket stage logic & sky color ---------- */
const stages = [
  { id:'base', min:0, max:2499, skyTop:'#0b2340', skyBottom:'#031022' },
  { id:'mk2', min:2500, max:4999, skyTop:'#071a2f', skyBottom:'#020b18' },
  { id:'mk3', min:5000, max:9999, skyTop:'#1a0b2f', skyBottom:'#050115' },
  // from 10k onwards we pick late variants; visual variants will be in stage-late (randomized)
];
let lastStageIndex = -1;
const lateVariants = [
  { name:'lateA', skyTop:'#05010d', skyBottom:'#00020a' },
  { name:'lateB', skyTop:'#0b0012', skyBottom:'#00010a' },
  { name:'lateC', skyTop:'#000113', skyBottom:'#00000b' }
];
let activeLateIndex = 0;

function computeStageIndex(fuelVal){
  if(fuelVal < 2500) return 0;
  if(fuelVal < 5000) return 1;
  if(fuelVal < 10000) return 2;
  // 10k+ -> late pool changes every 5k
  const extra = Math.floor((fuelVal - 10000) / 5000);
  // map to lateVariants index (cycle through)
  return 3 + (extra % lateVariants.length);
}
function applyRocketStage(){
  const idx = computeStageIndex(state.fuel);
  if(idx !== lastStageIndex){
    // handle swap animation
    // fade out previous, fade in new
    fadeStageTo(idx);
    lastStageIndex = idx;
  }
  // sky color update
  setSkyFromStage(idx);
}

function fadeStageTo(index){
  // determine which DOM stage to show
  // index 0 -> stage-0, 1->stage-1, 2->stage-2, >=3 -> stage-late (but pick variant by activeLateIndex)
  const allStages = document.querySelectorAll('.rocket-stage');
  allStages.forEach(s=> s.classList.remove('active'));
  if(index <= 2){
    const id = `stage-${index}`;
    document.getElementById(id).classList.add('active');
  } else {
    // choose late variant index from computed bucket for cosmetic variety
    activeLateIndex = ((Math.floor((state.fuel - 10000)/5000)) % lateVariants.length + lateVariants.length) % lateVariants.length;
    document.getElementById('stage-late').classList.add('active');
  }
  // sparkle on swap
  spawnSparkles(28);
}

/* ---------- Sky color transitions ---------- */
function setSkyFromStage(index){
  let top, bottom;
  if(index <= 2){
    top = stages[index].skyTop;
    bottom = stages[index].skyBottom;
  } else {
    const li = lateVariants[activeLateIndex % lateVariants.length];
    top = li.skyTop; bottom = li.skyBottom;
  }
  // animate root background gradient via CSS variables
  const root = document.documentElement;
  root.style.transition = 'background 420ms linear';
  root.style.setProperty('--sky-top', top);
  root.style.setProperty('--sky-bottom', bottom);
  // also tweak star speed/visibility according to stage to feel like higher altitude
  const starField = document.getElementById('starField');
  if(index <= 0) starField.style.setProperty('--drift-speed', '80s');
  else if(index === 1) starField.style.setProperty('--drift-speed', '70s');
  else if(index === 2) starField.style.setProperty('--drift-speed', '55s');
  else starField.style.setProperty('--drift-speed', '36s');
}

/* ---------- Stars & Shooting Stars ---------- */
function buildStarField(){
  const starField = document.getElementById('starField');
  starField.innerHTML = '';
  for(let i=0;i<120;i++){
    const s = document.createElement('div');
    s.className = 'star';
    s.style.left = Math.random()*100 + '%';
    s.style.top = Math.random()*100 + '%';
    s.style.opacity = (0.2 + Math.random()*0.9);
    const scale = 0.5 + Math.random()*2;
    s.style.transform = `scale(${scale})`;
    // random drift speed variance
    const v = 40 + Math.random()*120;
    s.style.setProperty('--drift-speed', v + 's');
    s.style.animationDuration = (40 + Math.random()*100) + 's';
    starField.appendChild(s);
  }
}
function spawnShootingStar(){
  const sky = document.getElementById('sky');
  const s = document.createElement('div');
  s.className = 'shoot';
  // choose random start along top or side
  const edge = Math.random();
  let startX, startY, angle;
  if(edge < 0.6){
    // start near top at random X
    startX = Math.random() * sky.clientWidth * 0.9 + sky.clientWidth*0.05;
    startY = Math.random() * 60 + 10;
    // angle down-right or down-left randomly
    angle = (Math.random() < 0.5) ? (20 + Math.random()*40) : (120 + Math.random()*40);
  } else {
    // start from left or right side
    if(Math.random() < 0.5){
      startX = -20;
      startY = Math.random() * sky.clientHeight * 0.7 + 20;
      angle = 20 + Math.random() * 60;
    } else {
      startX = sky.clientWidth + 20;
      startY = Math.random() * sky.clientHeight * 0.7 + 20;
      angle = 200 + Math.random() * 60;
    }
  }
  s.style.left = startX + 'px';
  s.style.top = startY + 'px';
  s.style.width = '6px';
  s.style.height = '6px';
  fxLayer.appendChild(s);

  // movement distance and duration
  const dist = 800 + Math.random()*700;
  const rad = angle * Math.PI / 180;
  const dx = Math.cos(rad) * dist;
  const dy = Math.sin(rad) * dist;
  s.animate([
    { transform: 'translate(0,0) scale(1)', opacity: 1, filter: 'blur(0px)' },
    { transform: `translate(${dx}px, ${dy}px) scale(0.6)`, opacity: 0, filter: 'blur(4px)' }
  ], { duration: 900 + Math.random()*800, easing: 'cubic-bezier(.2,.9,.2,1)' });
  setTimeout(()=> s.remove(), 1800);
}
function shootingStarLoop(){
  const t = 10000 + Math.random()*10000; // every 10-20s
  setTimeout(()=>{
    // spawn 1-3 shooting stars
    const count = 1 + Math.floor(Math.random()*3);
    for(let i=0;i<count;i++){
      setTimeout(spawnShootingStar, Math.random()*800);
    }
    shootingStarLoop();
  }, t);
}

/* ---------- Flame intensity based on recent clicks ---------- */
function updateFlameIntensity(){
  const flames = document.querySelectorAll('.flame');
  // base intensity + factor from recent clicks (clickBurstCount)
  const intensity = Math.min(2.6, 1 + state.clickBurstCount * 0.18);
  flames.forEach(f=>{
    f.style.transform = `translateX(-50%) scaleY(${intensity})`;
    // also slightly increase opacity
    f.style.opacity = Math.min(1, 0.7 + (intensity-1)/1.3);
  });
}

/* ---------- Event bindings ---------- */
document.getElementById('rocketWrap').addEventListener('click', ()=> doClick(1));
document.addEventListener('keydown', (e)=> { if(e.code === 'Space'){ e.preventDefault(); doClick(1); }});
document.getElementById('saveBtn').addEventListener('click', save);
document.getElementById('resetBtn').addEventListener('click', ()=> {
  if(confirm('Reset progress?')){ localStorage.removeItem('rocket_save_v2'); location.reload(); }
});
prestigeBtn.addEventListener('click', ()=> {
  // placeholder: will be wired later
  alert('Prestige unlocked! (placeholder)'); 
});

/* ---------- Auto-save ---------- */
setInterval(save, 15000);
window.addEventListener('beforeunload', save);

/* ---------- Init ---------- */
function init(){
  buildStarField();
  recalc();
  renderUI();
  load();
  // ensure rocket default visibility
  fadeStageTo(computeStageIndex(state.fuel));
  // start tick loop
  setInterval(tick, 500);
  // star shooting loop
  shootingStarLoop();
  // small welcome popup
  setTimeout(()=> spawnPopup('Welcome, Commander!'), 600);
}

// initial call
init();

/* ---------- Render store initially and on changes ---------- */
renderStore();

/* ---------- Periodic UI updates (store reorder) ---------- */
setInterval(()=> {
  recalc();
  renderUI();
}, 1000);

/* ---------- Misc: make store click safe to map to original items ---------- */
function buyItemById(id){
  buyItem(id);
}
</script>
</body>
</html>
