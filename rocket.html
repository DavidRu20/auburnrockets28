<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rocket Clicker â€” Final Optimized</title>
<style>
  /* ============================
     Dark / Minimal / Performance
     ============================ */
  :root{
    --bg-top:#02040b;
    --bg-bottom:#000109;
    --muted:#7f9fb5;
    --accent:#ff8a2b;
    --panel: rgba(255,255,255,0.02);
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom));font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;color:#dfeffb}
  .app{max-width:1200px;margin:14px auto;display:grid;grid-template-columns:1fr 360px;gap:14px;padding:12px}
  header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:18px}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:10px;padding:10px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  main.left{padding:8px}
  .sky{position:relative;height:640px;border-radius:10px;overflow:hidden}
  .star-layer{position:absolute;inset:0;pointer-events:none}
  .star{position:absolute;border-radius:50%;background:rgba(255,255,255,0.9);filter:blur(.28px);opacity:.12}
  canvas#nebula{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;mix-blend-mode:screen;opacity:0.06}
  #planets{position:absolute;inset:0;pointer-events:none}
  .planet{position:absolute;border-radius:50%;filter:blur(1.6px);opacity:0.06}

  /* Rocket wrapper */
  .rocket-wrap{position:absolute;left:50%;bottom:8%;transform:translateX(-50%);transition:transform .28s cubic-bezier(.2,.9,.2,1);will-change:left,bottom,transform}
  .rocket-el{width:200px;height:320px;pointer-events:none;transform-origin:center}
  /* GPU bounce implemented via CSS keyframe - toggled with .bounce */
  .bounce{animation:rocket-bounce 140ms ease-out}
  @keyframes rocket-bounce{
    0%{ transform: translateY(0) scale(1) }
    30%{ transform: translateY(-8px) scale(1.02) }
    100%{ transform: translateY(0) scale(1) }
  }

  .flame{position:absolute;left:50%;bottom:-28px;transform:translateX(-50%) scaleY(1);transform-origin:50% 0%;pointer-events:none;transition:transform 120ms}
  #fx{position:absolute;inset:0;pointer-events:none}
  .particle, .shoot, .trail{position:absolute;pointer-events:none;border-radius:50%;will-change:transform,opacity}
  .trail{filter:blur(1.2px);border-radius:6px}
  .shoot{box-shadow:0 0 10px rgba(255,255,255,0.04)}
  .hit-flash{position:absolute;inset:0;pointer-events:none;background:rgba(255,255,255,0);transition:background 110ms}
  .shake{animation:shake 260ms linear}
  @keyframes shake{0%{transform:translate(0)}20%{transform:translate(-6px,3px)}40%{transform:translate(6px,-3px)}60%{transform:translate(-4px,2px)}80%{transform:translate(4px,-2px)}100%{transform:translate(0)}}

  /* HUD/shop */
  .hud{margin-top:10px;display:flex;justify-content:space-between;align-items:center}
  .fuel-counter{font-weight:800;font-size:20px}
  .muted{color:var(--muted);font-size:13px}
  .shop{display:flex;flex-direction:column;gap:8px}
  .store-list{max-height:440px;overflow:auto;padding-right:6px}
  .item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:pointer;transition:transform .06s}
  .item:hover{transform:translateY(-3px)}
  .item.locked{opacity:0.46;cursor:not-allowed;transform:none}
  .name{font-weight:700}
  .num{color:var(--muted)}
  button{background:linear-gradient(180deg,#0d2830,#08131a);border:1px solid rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;color:#cfeefb;cursor:pointer}
  .settings{display:flex;gap:8px;align-items:center}
  .toggle{width:44px;height:24px;background:#0b2530;border-radius:14px;position:relative;cursor:pointer}
  .toggle-dot{position:absolute;top:3px;left:3px;width:18px;height:18px;background:#dff6ff;border-radius:50%;transition:left .18s}
  .toggle.on{background:#153a46}
  .toggle.on .toggle-dot{left:23px}

  footer{grid-column:1/-1;margin-top:8px;text-align:center;color:var(--muted);font-size:13px}
  @media (max-width:980px){.app{grid-template-columns:1fr}.sky{height:520px}}
</style>
</head>
<body>
  <div class="app" id="appRoot">
    <header>
      <h1>ðŸš€ Rocket Clicker â€” Fast & Dark</h1>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="muted">Fuel: <span id="fuelTop">0</span></div>
        <div class="settings">
          <div id="perfToggle" class="toggle" title="Performance Mode"><div class="toggle-dot"></div></div>
          <button id="saveBtn">Save</button>
          <button id="resetBtn">Reset</button>
        </div>
      </div>
    </header>

    <main class="left panel">
      <div class="sky" id="sky">
        <div class="star-layer" id="stars-far"></div>
        <canvas id="nebula"></canvas>
        <div class="star-layer" id="stars-mid"></div>
        <div class="star-layer" id="stars-near"></div>
        <div id="planets"></div>

        <div class="rocket-wrap" id="rocketWrap">
          <div class="rocket-el" id="rocketEl" aria-hidden="true">
            <!-- single parametric SVG; cleaned silhouette -->
            <svg id="rocketSVG" viewBox="0 0 200 320" width="200" height="320" preserveAspectRatio="xMidYMid meet">
              <defs><linearGradient id="gBody" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#eaf7ff"/><stop offset="100%" stop-color="#cfeefb" stop-opacity="0.06"/></linearGradient></defs>
              <ellipse id="shadow" cx="100" cy="292" rx="36" ry="10" fill="#000" opacity="0.12"/>
              <g id="bodyGroup" transform="translate(0,6)">
                <rect id="bodyRect" x="70" y="36" width="60" height="140" rx="18" fill="#0f2a36" stroke="#7fbddf" stroke-opacity="0.06"/>
                <path id="nose" d="M100 12 C88 34,112 34,100 12 Z" fill="#b86b3f"/>
                <circle id="cockpit" cx="100" cy="88" r="12" fill="#0b2b32" stroke="#9edfff" stroke-opacity="0.08"/>
                <g id="fins"></g>
                <g id="boosters"></g>
                <g id="lights"></g>
              </g>
            </svg>
          </div>
          <div class="flame" id="flameWrap">
            <svg id="flameSVG" viewBox="0 0 48 80" width="76" height="110" preserveAspectRatio="xMidYMid meet">
              <path id="flameOuter" d="M24 2 C12 24,10 44,24 70 C38 44,36 24,24 2 Z" fill="#ffd7a6"/>
              <path id="flameInner" d="M24 18 C18 36,16 44,24 58 C32 44,30 36,24 18 Z" fill="#ff7a18"/>
            </svg>
          </div>
        </div>

        <div id="fx"></div>
        <div class="hit-flash" id="hitFlash"></div>
      </div>

      <div class="hud panel" style="margin-top:12px;display:flex;align-items:center;justify-content:space-between">
        <div>
          <div class="fuel-counter" id="fuel">0</div>
          <div class="muted small">fuel units</div>
        </div>
        <div style="text-align:right">
          <div class="muted small">Per Click: <span id="perClick">1</span></div>
          <div class="muted small">Per Second: <span id="perSecond">0</span></div>
        </div>
      </div>
    </main>

    <aside class="panel">
      <h3 style="margin-top:0">Launch Bay â€” Shop</h3>
      <div class="muted small">Engineers (autoclickers), Thrusters (click boosts), Labs (multipliers). Gyro unlocks WASD.</div>
      <div style="height:8px"></div>
      <div class="shop">
        <div class="store-list panel" id="storeList"></div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div class="muted small">Rocket Altitude</div>
          <div id="altitude" class="fuel-counter">0%</div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div class="muted small">Prestige</div>
          <div id="prestigeWrap"><button id="prestigeBtn" style="display:none">Prestige (1,000,000)</button></div>
        </div>
      </div>
    </aside>

    <footer class="muted small">Tip: Click to glide. Buy Gyro Stabilizer to enable WASD/Arrow controls. Toggle perf mode to reduce effects.</footer>
  </div>

<script>
/* ============================
   Final Click-optimized JS
   - particle pooling
   - CSS GPU bounce
   - immediate UI update on click (minimal DOM writes)
   - rAF visual loop + slower economic tick
   ============================ */

/* --------- CONFIG & TIERS ---------- */
const TIERS = [
  {name:'Base', threshold:0, fins:0, boosters:0, body:'#0f2a36', nose:'#b86b3f', cockpit:'#0b2b32', flame1:'#ffd7a6', flame2:'#ff7a18', flameScale:1},
  {name:'1', threshold:300, fins:1, boosters:0, body:'#10313b', nose:'#b87040', cockpit:'#0c3139', flame1:'#ffe0b0', flame2:'#ff7a18', flameScale:1.06},
  {name:'2', threshold:700, fins:1, boosters:0, body:'#133b44', nose:'#c07345', cockpit:'#0d3740', flame1:'#ffe3b6', flame2:'#ff7a28', flameScale:1.08},
  {name:'3', threshold:1400, fins:2, boosters:1, body:'#0f3f44', nose:'#c07f52', cockpit:'#0e4046', flame1:'#fff0c6', flame2:'#ff8328', flameScale:1.12},
  {name:'4', threshold:2600, fins:2, boosters:1, body:'#0b4250', nose:'#cf7a4e', cockpit:'#0f444b', flame1:'#fff2d0', flame2:'#ff8a2b', flameScale:1.18},
  {name:'5', threshold:4200, fins:2, boosters:2, body:'#0a3f4f', nose:'#d07e5a', cockpit:'#123f47', flame1:'#fff5d8', flame2:'#ff8f2b', flameScale:1.24},
  {name:'6', threshold:6400, fins:3, boosters:2, body:'#0b3550', nose:'#d78d64', cockpit:'#153f49', flame1:'#fff9dd', flame2:'#ff7a4f', flameScale:1.30},
  {name:'7', threshold:9200, fins:3, boosters:2, body:'#0b2f46', nose:'#e08f6e', cockpit:'#163d46', flame1:'#fffbe0', flame2:'#ff6b3b', flameScale:1.36},
  {name:'8', threshold:12500, fins:3, boosters:3, body:'#09283f', nose:'#e48f7a', cockpit:'#13363f', flame1:'#fffce4', flame2:'#ff5f4c', flameScale:1.44},
  {name:'9', threshold:17000, fins:4, boosters:3, body:'#061f36', nose:'#ee9fa0', cockpit:'#0f2f38', flame1:'#fffce6', flame2:'#ff4f7a', flameScale:1.52},
  {name:'10', threshold:22000, fins:4, boosters:4, body:'#061a30', nose:'#ffb3b3', cockpit:'#0d2831', flame1:'#fffef0', flame2:'#ff3fa9', flameScale:1.6},
  {name:'11', threshold:30000, fins:4, boosters:4, body:'#041828', nose:'#ffd7d0', cockpit:'#0b232b', flame1:'#fffef4', flame2:'#ff2fd0', flameScale:1.72},
  {name:'12', threshold:42000, fins:5, boosters:4, body:'#03121f', nose:'#ffd7ff', cockpit:'#06141b', flame1:'#fff8ff', flame2:'#d24bff', flameScale:1.86},
  {name:'13', threshold:58000, fins:5, boosters:5, body:'#020f19', nose:'#ffd2ff', cockpit:'#041018', flame1:'#fff9ff', flame2:'#b83aff', flameScale:2.02},
  {name:'14', threshold:76000, fins:5, boosters:5, body:'#010911', nose:'#ffb7ff', cockpit:'#020a10', flame1:'#fff9ff', flame2:'#8b2bff', flameScale:2.2},
  {name:'15', threshold:98000, fins:6, boosters:6, body:'#000712', nose:'#ff9aff', cockpit:'#00090f', flame1:'#fff9ff', flame2:'#6b1fff', flameScale:2.4},
  {name:'16', threshold:130000, fins:6, boosters:6, body:'#00060d', nose:'#ff8aee', cockpit:'#00080d', flame1:'#fff9ff', flame2:'#4b1fff', flameScale:2.7},
  {name:'17', threshold:170000, fins:7, boosters:7, body:'#00040a', nose:'#ff6bff', cockpit:'#00060b', flame1:'#fff9ff', flame2:'#2b12ff', flameScale:3.0}
];

const SHOP = [
  {id:'engineer', name:'Engineer', desc:'Automate clicks.', base:12, cps:0.18},
  {id:'robot', name:'Junior Robot', desc:'Better automation.', base:48, cps:0.9},
  {id:'thruster', name:'Thruster', desc:'Improve click power.', base:56, cpc:1.8},
  {id:'adv_thruster', name:'Advanced Thruster', desc:'Big click boost.', base:420, cpc:7},
  {id:'lab', name:'Research Lab', desc:'Multiply thrusters.', base:950, type:'mult', mult:1.45},
  {id:'sat', name:'Satellite', desc:'Passive sensors.', base:1400, cps:12},
  {id:'ai', name:'AI Systems', desc:'Smart systems.', base:7200, cps:72},
  {id:'factory', name:'Factory', desc:'Mass production.', base:32000, cps:320},
  {id:'gyro', name:'Gyro Stabilizer', desc:'Unlock WASD/Arrow flight control.', base:250000, special:'enableWASD'},
  {id:'hud', name:'Command Bridge', desc:'Upgrade HUD visuals.', base:520000, special:'hudSkin'},
  {id:'megafactory', name:'Mega Factory', desc:'Huge passive.', base:220000, cps:1900},
  {id:'orbital', name:'Orbital Platform', desc:'Advanced passive.', base:1500000, cps:12000},
  {id:'colony', name:'Lunar Colony', desc:'Off-world production.', base:7500000, cps:56000},
  {id:'dyson', name:'Dyson Swarm', desc:'Massive power.', base:45000000, cps:350000},
  {id:'quantum', name:'Quantum Lab', desc:'Multiply thrusters.', base:180000000, type:'mult', mult:2.0}
];

const STAR_SPAWN_MIN = 18000;
const STAR_SPAWN_MAX = 42000;
const MAX_PARTICLES = 24;
const MAX_STARS = 8;
const SAVE_KEY = 'rocket_final_v1';
const PERF_KEY = 'rocket_perf_v1';

/* ----------- STATE -------------- */
const state = {
  fuel:0, perClick:1, perSecond:0, lastTick:Date.now(), clickBurst:0, prestige:0,
  items: SHOP.map(x=>Object.assign({qty:0},x)),
  rocket:{x:0,y:0,tx:null,ty:null,easing:0.13, useWASD:false},
  perfMode: (localStorage.getItem(PERF_KEY) === '1'),
  lastFuelShown: null
};

/* ----------- DOM refs ----------- */
const fuelEl = document.getElementById('fuel');
const fuelTop = document.getElementById('fuelTop');
const perClickEl = document.getElementById('perClick');
const perSecondEl = document.getElementById('perSecond');
const storeList = document.getElementById('storeList');
const sky = document.getElementById('sky');
const rocketWrap = document.getElementById('rocketWrap');
const rocketEl = document.getElementById('rocketEl');
const flameWrap = document.getElementById('flameWrap');
const fx = document.getElementById('fx');
const hitFlash = document.getElementById('hitFlash');
const perfToggle = document.getElementById('perfToggle');
const altitudeEl = document.getElementById('altitude');

/* --------- Audio (preload / simple) ------------ */
let audioCtx = null;
function ensureAudio(){
  if(audioCtx) return;
  try{ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }catch(e){ audioCtx = null; }
}
function sfx(freq, type='sine', dur=0.08, vol=0.06){
  if(!audioCtx) return;
  const t = audioCtx.currentTime;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type; o.frequency.value = freq; g.gain.value = vol;
  o.connect(g); g.connect(audioCtx.destination);
  o.start(t); g.gain.exponentialRampToValueAtTime(0.001, t + dur); o.stop(t + dur + 0.02);
}

/* ---------- UTIL ---------- */
function fmt(n){ if(n<1000) return Math.round(n*100)/100; const si=['','K','M','B','T']; let i=0; while(n>=1000 && i<si.length-1){ n/=1000; i++; } return (Math.round(n*100)/100)+si[i]; }
function now(){ return Date.now(); }

/* -------- SAVE / LOAD ------- */
function saveGame(){
  try{
    const payload = { fuel: state.fuel, prestige: state.prestige, items: state.items.map(i=>({id:i.id,qty:i.qty})), useWASD: state.rocket.useWASD, perf: state.perfMode };
    localStorage.setItem(SAVE_KEY, JSON.stringify(payload));
    spawnPopup('Saved');
  }catch(e){console.error(e);}
}
function loadGame(){
  try{
    const raw = localStorage.getItem(SAVE_KEY); if(!raw) return;
    const s = JSON.parse(raw);
    state.fuel = s.fuel||0; state.prestige = s.prestige||0;
    if(Array.isArray(s.items)) s.items.forEach(si=>{ const it = state.items.find(x=>x.id===si.id); if(it) it.qty = si.qty||0; });
    if(s.useWASD) state.rocket.useWASD = true;
    if(s.perf) state.perfMode = true;
  }catch(e){console.error(e);}
}

/* ---------- SHOP ---------- */
function itemCost(it){ return Math.ceil(it.base * Math.pow(1.135, it.qty)); }
function sortedItems(){ return state.items.map(it=>({ ...it, cost: itemCost(it) })).sort((a,b)=>a.cost-b.cost); }
function unlocked(i){ if(i===0) return true; return state.items[i-1].qty > 0; }
function recalc(){
  let pc = 1, ps = 0;
  state.items.forEach(it=>{
    if(it.cpc) pc += it.cpc * it.qty;
    if(it.cps) ps += it.cps * it.qty;
    if(it.type === 'mult' && it.qty>0) pc *= Math.pow(it.mult, it.qty);
  });
  state.perClick = pc; state.perSecond = ps;
}

/* render store (not heavy) */
function renderStore(){
  storeList.innerHTML = '';
  sortedItems().forEach(si=>{
    const idx = state.items.findIndex(x=>x.id===si.id);
    const ok = unlocked(idx);
    const el = document.createElement('div'); el.className = 'item' + (ok ? '' : ' locked');
    el.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><div><div class="name">${si.name}</div><div class="muted small">${si.desc}</div></div></div><div style="text-align:right"><div class="num">${ ok ? fmt(si.cost) : '<span class="locked-tag">Locked</span>' }</div><div class="muted small">Owned: ${si.qty}</div></div>`;
    el.addEventListener('click', ()=> { if(!ok){ lockedFeedback(); return; } buy(si.id); });
    storeList.appendChild(el);
  });
}
function buy(id){
  const it = state.items.find(x=>x.id===id); if(!it) return;
  const c = itemCost(it);
  if(state.fuel >= c){
    state.fuel -= c; it.qty++;
    if(it.special === 'enableWASD' || it.id === 'gyro'){ state.rocket.useWASD = true; spawnPopup('Gyro Stabilizer â€” WASD enabled'); }
    if(it.special === 'hudSkin' || it.id === 'hud'){ document.documentElement.classList.add('hud-skin'); spawnPopup('Command Bridge active'); }
    recalc(); renderStore(); spawnSparkles(10); sfx(1200,'sine',0.12,0.06);
    immediateFuelUpdate(); // immediate visual feedback
  } else { lockedFeedback(); }
}

/* ---------- PARTICLE POOL (reused) ---------- */
const PARTICLES = [];
for(let i=0;i<MAX_PARTICLES;i++){
  const el = document.createElement('div'); el.className='particle'; el.style.opacity=0; el._busy=false; fx.appendChild(el); PARTICLES.push(el);
}
function getParticle(){ return PARTICLES.find(p=>!p._busy); }
function spawnParticle(x,y,size,color,dx,dy,dur=700){
  const p = getParticle(); if(!p) return;
  p._busy = true; p.style.left = x + 'px'; p.style.top = y + 'px'; p.style.width = size + 'px'; p.style.height = size + 'px'; p.style.background = color; p.style.opacity = 1;
  // animate with Web Animations API (fast)
  p.animate([{ transform:'translate(0,0) scale(1)', opacity:1 }, { transform:`translate(${dx}px, ${dy}px) scale(0.2)`, opacity:0 }], { duration:dur, easing:'cubic-bezier(.2,.9,.2,1)' });
  setTimeout(()=>{ p._busy = false; p.style.opacity = 0; }, dur);
}
function spawnSparkles(n=8){
  if(state.perfMode) n = Math.max(4, Math.floor(n/2));
  const fxr = fx.getBoundingClientRect(); const rwrap = rocketWrap.getBoundingClientRect();
  const cx = rwrap.left + rwrap.width/2 - fxr.left; const cy = rwrap.top + rwrap.height - fxr.top - 18;
  for(let i=0;i<n;i++){
    const dx = (Math.random()*120-60); const dy = -(60 + Math.random()*160); const size = 3 + Math.random()*6;
    spawnParticle(cx + (Math.random()*20-10), cy + (Math.random()*8-4), size, '#ffd9b3', dx, dy, 640 + Math.random()*320);
  }
}
function spawnExhaust(intensity=1){
  const fxr = fx.getBoundingClientRect(); const rwrap = rocketWrap.getBoundingClientRect();
  const cx = rwrap.left + rwrap.width/2 - fxr.left; const cy = rwrap.top + rwrap.height - fxr.top - 16;
  const count = Math.max(1, Math.round(3 * Math.min(intensity, state.perfMode ? 0.9 : intensity)));
  for(let i=0;i<count;i++){
    const angle = Math.PI + (Math.random()-0.5)*0.9;
    const speed = (16 + Math.random()*40) * intensity;
    const dx = Math.cos(angle)*speed + (Math.random()*10-5);
    const dy = Math.sin(angle)*speed + (Math.random()*8-4);
    const size = 5 + Math.random()*7;
    spawnParticle(cx + (Math.random()*18-9), cy + (Math.random()*6-3), size, getCurrentTier().flame1, dx, dy, 580 + Math.random()*240);
  }
}

/* ---------- SHOOTING STARS (pooled) ---------- */
const STAR_POOL = [];
for(let i=0;i<MAX_STARS;i++){
  const el = document.createElement('div'); el.className='shoot'; el.style.width='8px'; el.style.height='8px'; el.style.opacity=0; el._busy=false; fx.appendChild(el);
  const tr = document.createElement('div'); tr.className='trail'; tr.style.opacity=0; tr._busy=false; fx.appendChild(tr);
  STAR_POOL.push({el,tr,_busy:false});
}
function getFreeStar(){ return STAR_POOL.find(s=>!s._busy); }
function spawnShootingStar(){
  const s = getFreeStar(); if(!s) return;
  const rect = sky.getBoundingClientRect();
  const types = [
    {name:'white', color:'#fff5d6', trail:'#ffd8a8', speed:[520,920], size:[6,10], penalty:0.06},
    {name:'blue', color:'#a6e0ff', trail:'#9fd9ff', speed:[700,1100], size:[4,8], penalty:0.05},
    {name:'red', color:'#ffb3b3', trail:'#ffb3b3', speed:[260,460], size:[10,16], penalty:0.11},
    {name:'green', color:'#bfffd6', trail:'#bfffd6', speed:[520,760], size:[5,9], penalty:0.045}
  ];
  let r = Math.random(), t = types[0];
  if(r < 0.6) t = types[0]; else if(r < 0.82) t = types[1]; else if(r < 0.95) t = types[2]; else t = types[3];
  // spawn top/left/right
  let sx, sy, angle;
  if(Math.random() < 0.7){ sx = Math.random()*rect.width*0.85 + rect.width*0.075; sy = -20; angle = 30 + Math.random()*80; if(Math.random() < 0.5) angle = 120 + Math.random()*40; }
  else { if(Math.random() < 0.5){ sx = -40; sy = Math.random()*rect.height*0.7 + 20; angle = 10 + Math.random()*60; } else { sx = rect.width + 40; sy = Math.random()*rect.height*0.7 + 20; angle = 200 + Math.random()*60; } }
  const speed = t.speed[0] + Math.random()*(t.speed[1]-t.speed[0]); const size = t.size[0] + Math.random()*(t.size[1]-t.size[0]);
  const rad = angle * Math.PI / 180; const vx = Math.cos(rad)*speed, vy = Math.sin(rad)*speed;
  s._busy = true; s.x = sx; s.y = sy; s.vx = vx; s.vy = vy; s.size = size; s.type = t;
  s.el.style.left = sx + 'px'; s.el.style.top = sy + 'px'; s.el.style.width = size + 'px'; s.el.style.height = size + 'px'; s.el.style.background = t.color; s.el.style.opacity = 1;
  s.tr.style.left = sx + 'px'; s.tr.style.top = sy + 'px'; s.tr.style.width = (size*5) + 'px'; s.tr.style.height = Math.max(4, size/1.6) + 'px'; s.tr.style.background = `linear-gradient(90deg, ${t.trail}, rgba(0,0,0,0))`; s.tr.style.opacity = state.perfMode ? 0 : 0.9;
}
function updateShootingStars(dt){
  const rect = sky.getBoundingClientRect();
  for(let i=0;i<STAR_POOL.length;i++){
    const s = STAR_POOL[i]; if(!s._busy) continue;
    s.x += s.vx * dt; s.y += s.vy * dt;
    s.el.style.left = s.x + 'px'; s.el.style.top = s.y + 'px';
    const ang = Math.atan2(s.vy, s.vx) * 180/Math.PI;
    s.tr.style.transform = `rotate(${ang}deg) translateX(${-s.size*1.8}px)`; s.tr.style.left = s.x + 'px'; s.tr.style.top = s.y + 'px';
    // collision
    const fxr = fx.getBoundingClientRect(); const rwrap = rocketWrap.getBoundingClientRect();
    if(!rwrap.width) continue;
    const rcx = rwrap.left + rwrap.width/2 - fxr.left; const rcy = rwrap.top + rwrap.height/2 - fxr.top;
    const dx = s.x - rcx, dy = s.y - rcy; const dist = Math.hypot(dx,dy);
    const hitRadius = Math.max(24, rwrap.width*0.22) + s.size*0.6;
    if(dist < hitRadius){
      const lost = Math.max(1, Math.round(state.fuel * s.type.penalty));
      state.fuel = Math.max(0, state.fuel - lost);
      appShake(0.26); spawnFloating(`-${fmt(lost)} fuel`, s.x + fxr.left, s.y + fxr.top); spawnSparkles(10); sfx(160,'square',0.08,0.18);
      s.el.style.opacity = 0; s.tr.style.opacity = 0; s._busy = false; immediateFuelUpdate();
      continue;
    }
    if(s.x < -300 || s.x > rect.width + 300 || s.y < -300 || s.y > rect.height + 300){ s.el.style.opacity = 0; s.tr.style.opacity = 0; s._busy = false; }
  }
}
function starSpawnerLoop(){
  const next = STAR_SPAWN_MIN + Math.random()*(STAR_SPAWN_MAX - STAR_SPAWN_MIN);
  setTimeout(()=>{ spawnShootingStar(); if(Math.random()>0.4) setTimeout(spawnShootingStar, 200 + Math.random()*800); starSpawnerLoop(); }, next);
}

/* ---------- ROCKET VISUALS ---------- */
let lastTierIdx = -1;
function getCurrentTierIndex(){
  let idx = 0;
  for(let i=0;i<TIERS.length;i++){ if(state.fuel >= TIERS[i].threshold) idx = i; else break; }
  return Math.min(idx, TIERS.length-1);
}
function applyTierVisuals(){
  const idx = getCurrentTierIndex();
  if(idx !== lastTierIdx){
    rocketEl.style.opacity = 0.06; rocketEl.style.transform = 'scale(.98)';
    setTimeout(()=> {
      const t = TIERS[idx];
      document.getElementById('bodyRect').setAttribute('fill', t.body);
      document.getElementById('nose').setAttribute('fill', t.nose);
      document.getElementById('cockpit').setAttribute('fill', t.cockpit);
      // fins
      const fins = document.getElementById('fins'); fins.innerHTML = '';
      for(let i=0;i<t.fins;i++){
        const l = document.createElementNS('http://www.w3.org/2000/svg','path'); l.setAttribute('d', `M${58 - i*6 + 10} 132 L${58 - i*6 - 18} 168 L${58 - i*6 + 26} 142 Z`); l.setAttribute('fill','#072730'); fins.appendChild(l);
        const r = document.createElementNS('http://www.w3.org/2000/svg','path'); r.setAttribute('d', `M${142 + i*6 - 10} 132 L${142 + i*6 + 18} 168 L${142 + i*6 - 26} 142 Z`); r.setAttribute('fill','#072730'); fins.appendChild(r);
      }
      // boosters
      const boosters = document.getElementById('boosters'); boosters.innerHTML = '';
      for(let b=0;b<t.boosters;b++){
        const x = 28 + b*18; const rr = document.createElementNS('http://www.w3.org/2000/svg','rect'); rr.setAttribute('x', x); rr.setAttribute('y', 152); rr.setAttribute('width', 14); rr.setAttribute('height', 60); rr.setAttribute('rx',6); rr.setAttribute('fill','#071f2a'); boosters.appendChild(rr);
        const rr2 = document.createElementNS('http://www.w3.org/2000/svg','rect'); rr2.setAttribute('x', 158 - b*18); rr2.setAttribute('y', 152); rr2.setAttribute('width', 14); rr2.setAttribute('height', 60); rr2.setAttribute('rx',6); rr2.setAttribute('fill','#071f2a'); boosters.appendChild(rr2);
      }
      // lights
      const lights = document.getElementById('lights'); lights.innerHTML = ''; const lc = Math.min(6, Math.max(1, Math.floor(idx/2)));
      for(let L=0;L<lc;L++){ const cx = 92 + L*6; const c = document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('cx', cx); c.setAttribute('cy', 72); c.setAttribute('r', 2.4); c.setAttribute('fill', '#ffd7b3'); lights.appendChild(c); }
      // flame
      document.getElementById('flameOuter').setAttribute('fill', t.flame1); document.getElementById('flameInner').setAttribute('fill', t.flame2);
      flameWrap.style.transform = `translateX(-50%) scaleY(${t.flameScale})`;
      rocketEl.style.transform = 'scale(1.02)'; rocketEl.style.opacity = 1;
      setTimeout(()=> rocketEl.style.transform = 'scale(1)', 300);
    }, 120);
    lastTierIdx = idx;
  }
  // subtle background shift
  const tt = TIERS[getCurrentTierIndex()];
  document.documentElement.style.setProperty('--bg-top', tt.body);
}

/* ---------- ROCKET MOVEMENT & CLICK ---------- */
function initRocketPosition(){
  const r = sky.getBoundingClientRect(); state.rocket.x = r.width/2; state.rocket.y = r.height*0.72; state.rocket.tx = state.rocket.x; state.rocket.ty = state.rocket.y; updateRocketDOM();
}
function skyToLocal(e){
  const r = sky.getBoundingClientRect(); let x,y;
  if(e.touches && e.touches[0]){ x = e.touches[0].clientX; y = e.touches[0].clientY; } else { x = e.clientX; y = e.clientY; }
  x -= r.left; y -= r.top; x = Math.max(40, Math.min(r.width-40, x)); y = Math.max(40, Math.min(r.height-40, y)); return {x,y};
}
sky.addEventListener('click', (e)=>{ const p = skyToLocal(e); state.rocket.tx = p.x; state.rocket.ty = p.y; });
sky.addEventListener('touchstart', (e)=>{ const p = skyToLocal(e); state.rocket.tx = p.x; state.rocket.ty = p.y; }, { passive:true });

const keys = {};
window.addEventListener('keydown', (e)=>{ keys[e.key] = true; if(e.code === 'Space'){ e.preventDefault(); clickAction(); }});
window.addEventListener('keyup', (e)=>{ keys[e.key] = false; });

function handleWASD(dt){
  if(!state.rocket.useWASD) return;
  const speed = 420; let moved=false;
  if(keys['w']||keys['ArrowUp']){ state.rocket.ty -= speed*dt; moved=true; }
  if(keys['s']||keys['ArrowDown']){ state.rocket.ty += speed*dt; moved=true; }
  if(keys['a']||keys['ArrowLeft']){ state.rocket.tx -= speed*dt; moved=true; }
  if(keys['d']||keys['ArrowRight']){ state.rocket.tx += speed*dt; moved=true; }
  if(moved) constrainRocketTargets();
}
function constrainRocketTargets(){ const r = sky.getBoundingClientRect(); state.rocket.tx = Math.max(40, Math.min(r.width-40, state.rocket.tx)); state.rocket.ty = Math.max(40, Math.min(r.height-40, state.rocket.ty)); }

function updateRocket(dt){
  handleWASD(dt);
  if(state.rocket.tx === null) return;
  const dx = state.rocket.tx - state.rocket.x, dy = state.rocket.ty - state.rocket.y;
  state.rocket.x += dx * Math.min(1, state.rocket.easing + dt*2.6);
  state.rocket.y += dy * Math.min(1, state.rocket.easing + dt*2.6);
  updateRocketDOM();
}
function updateRocketDOM(){
  const r = sky.getBoundingClientRect(); const px = state.rocket.x; const py = state.rocket.y; const bottom = r.height - py;
  rocketWrap.style.left = px + 'px'; rocketWrap.style.bottom = bottom + 'px';
  const tilt = Math.max(-10, Math.min(10, (state.rocket.tx - state.rocket.x) / 18));
  rocketWrap.style.transform = `translateX(-50%) translateY(0) rotate(${tilt}deg)`;
}

/* ---------- clickAction (snappy) ---------- */
function clickAction(){
  // minimal JS work here so it's instant
  state.clickBurst = Math.min(8, state.clickBurst + 1);
  state.fuel += state.perClick;
  // immediate UI feedback (only fuel display)
  immediateFuelUpdate();
  // GPU bounce: toggle class briefly, no layout thrash
  rocketEl.classList.add('bounce');
  setTimeout(()=> rocketEl.classList.remove('bounce'), 140);
  // spawn modest particles (pooled)
  spawnExhaust(1.2); spawnSparkles(6);
  // audio
  ensureAudio(); sfx(880,'triangle',0.06,0.05);
}

/* immediate fuel display update (avoids waiting for tick) */
function immediateFuelUpdate(){
  // only update if significantly different to avoid redundant writes
  if(state.lastFuelShown !== state.fuel){
    fuelEl.textContent = fmt(state.fuel);
    fuelTop.textContent = Math.round(state.fuel);
    state.lastFuelShown = state.fuel;
  }
}

/* ---------- FX helpers ---------- */
function spawnPopup(text){
  const el = document.createElement('div'); el.textContent = text; el.style.position='absolute'; el.style.left='50%'; el.style.top='26%';
  el.style.transform='translate(-50%,-50%)'; el.style.color='#ffd7b3'; el.style.fontWeight='700'; el.style.pointerEvents='none'; sky.appendChild(el);
  let t=0; const iv = setInterval(()=>{ t+=16; el.style.top = (26 - t/160) + '%'; el.style.opacity = 1 - t/900; if(t>900){ clearInterval(iv); el.remove(); } },16);
}
function spawnFloating(text, px, py){
  const fxr = fx.getBoundingClientRect(); const el = document.createElement('div'); el.textContent = text; el.style.position='absolute';
  el.style.left = (px - fxr.left) + 'px'; el.style.top = (py - fxr.top) + 'px'; el.style.transform='translate(-50%,-50%)'; el.style.color='#ffb38a'; el.style.fontWeight='700'; fx.appendChild(el);
  let t=0; const iv = setInterval(()=>{ t+=16; el.style.top = (py - fxr.top - t/20) + 'px'; el.style.opacity = 1 - t/900; if(t>900){ clearInterval(iv); el.remove(); } },16);
}
function appShake(duration=0.26){ appRoot.classList.add('shake'); hitFlash.style.background = 'rgba(255,255,255,0.06)'; setTimeout(()=>{ appRoot.classList.remove('shake'); hitFlash.style.background = 'rgba(255,255,255,0)'; }, duration*1000); }
function lockedFeedback(){ rocketWrap.style.transform = 'translateX(-50%) translateY(-8px)'; setTimeout(()=> rocketWrap.style.transform = 'translateX(-50%)', 120); }

/* ---------- TICK & Loops ---------- */
let lastRAF = performance.now();
function rafLoop(ts){
  const dt = (ts - lastRAF) / 1000; lastRAF = ts;
  // visuals - particles & stars
  updateShootingStars(dt);
  // flame intensity smoothing (not expensive)
  updateFlameVisual();
  requestAnimationFrame(rafLoop);
}
function slowTick(){
  // economy tick (every 500ms)
  if(state.perSecond > 0) state.fuel += state.perSecond * 0.5;
  state.clickBurst = Math.max(0, state.clickBurst - 0.5);
  recalc(); // recalculation is cheap
  // UI updates every tick (but fuel has immediate updates too)
  perClickEl.textContent = fmt(state.perClick); perSecondEl.textContent = fmt(state.perSecond);
  renderStore(); applyTierVisuals();
  // altitude and prestige
  const alt = Math.min(99, Math.sqrt(state.fuel / (1800 + state.prestige*700)) * 100);
  altitudeEl.textContent = Math.round(alt) + '%';
  document.getElementById('prestigeBtn').style.display = (state.fuel >= 1_000_000) ? 'inline-block' : 'none';
  // ensure fuel display remains current if tick changed it
  immediateFuelUpdate();
}

/* flame visual smoothing */
function updateFlameVisual(){
  // subtle bob or brightness based on clickBurst (cheap)
  const intensity = 1 + Math.min(7, state.clickBurst) * 0.18;
  const idx = getCurrentTierIndex(); const t = TIERS[idx];
  flameWrap.style.transform = `translateX(-50%) scaleY(${t.flameScale * intensity})`;
}

/* ---------- INIT / BOOT ---------- */
function boot(){
  // load state
  loadGame();
  recalc();
  renderStore();
  applyTierVisuals();
  // star layers
  const far = document.getElementById('stars-far'), mid = document.getElementById('stars-mid'), near = document.getElementById('stars-near');
  for(let i=0;i<70;i++){ const s=document.createElement('div'); s.className='star'; s.style.left=Math.random()*100+'%'; s.style.top=Math.random()*100+'%'; const r=0.6+Math.random()*1.2; s.style.width=s.style.height=r+'px'; s.style.opacity=0.06 + Math.random()*0.12; far.appendChild(s); }
  for(let i=0;i<36;i++){ const s=document.createElement('div'); s.className='star'; s.style.left=Math.random()*100+'%'; s.style.top=Math.random()*100+'%'; const r=1+Math.random()*1.6; s.style.width=s.style.height=r+'px'; s.style.opacity=0.08 + Math.random()*0.18; mid.appendChild(s); }
  for(let i=0;i<12;i++){ const s=document.createElement('div'); s.className='star'; s.style.left=Math.random()*100+'%'; s.style.top=Math.random()*100+'%'; const r=1.6+Math.random()*3; s.style.width=s.style.height=r+'px'; s.style.opacity=0.12 + Math.random()*0.28; near.appendChild(s); }

  // nebula canvas
  const canvas = document.getElementById('nebula'), ctx = canvas.getContext('2d');
  function resize(){ const r = sky.getBoundingClientRect(); canvas.width = r.width; canvas.height = r.height; }
  resize(); window.addEventListener('resize', resize);
  const blobs = []; for(let i=0;i<4;i++) blobs.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height*0.8, r:120+Math.random()*220, color:['#26478f','#3b2b6f','#2b6f6f','#5f2b5f'][i%4], vx:(Math.random()-0.5)*2, vy:(Math.random()-0.5)*0.4, a:0.03 + Math.random()*0.04});
  (function drawNeb(){ ctx.clearRect(0,0,canvas.width,canvas.height); blobs.forEach(b=>{ b.x += b.vx*0.06; b.y += b.vy*0.06; if(b.x > canvas.width + b.r) b.x = -b.r; if(b.x < -b.r) b.x = canvas.width + b.r; const g = ctx.createRadialGradient(b.x,b.y,b.r*0.02,b.x,b.y,b.r); g.addColorStop(0, hexToRgba(b.color, b.a*1.6)); g.addColorStop(0.45, hexToRgba(b.color, b.a)); g.addColorStop(1, hexToRgba('#000',0)); ctx.globalCompositeOperation='lighter'; ctx.fillStyle=g; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill(); }); requestAnimationFrame(drawNeb); })();

  // planets
  const planets = document.getElementById('planets'); planets.innerHTML=''; const p = document.createElement('div'); p.className='planet'; p.style.left='10%'; p.style.top='10%'; p.style.width='160px'; p.style.height='160px'; p.style.background='radial-gradient(circle,#2b2b44,#07101a)'; planets.appendChild(p);

  // perf toggle UI
  perfToggle.classList.toggle('on', state.perfMode);
  perfToggle.addEventListener('click', ()=>{ state.perfMode = !state.perfMode; localStorage.setItem(PERF_KEY, state.perfMode ? '1' : '0'); perfToggle.classList.toggle('on', state.perfMode); spawnPopup(state.perfMode ? 'Performance Mode ON' : 'Performance Mode OFF'); });

  // rocket pos init
  const r = sky.getBoundingClientRect(); state.rocket.x = r.width/2; state.rocket.y = r.height*0.72; state.rocket.tx = state.rocket.x; state.rocket.ty = state.rocket.y; updateRocketDOM();

  // events
  document.getElementById('saveBtn').addEventListener('click', ()=>{ saveGame(); ensureAudio(); sfx(900,'sine',0.12,0.06); });
  document.getElementById('resetBtn').addEventListener('click', ()=>{ if(confirm('Reset progress?')){ localStorage.removeItem(SAVE_KEY); location.reload(); }});
  rocketWrap.addEventListener('click', (e)=>{ e.stopPropagation(); clickAction(); });
  document.addEventListener('keydown', (e)=>{ if(e.code === 'Space'){ e.preventDefault(); clickAction(); }});
  // start loops
  requestAnimationFrame(rafLoop);
  setInterval(slowTick, 500);
  setInterval(saveGame, 15000);
  setTimeout(starSpawnerLoop, 1200);
  // warm audio when user interacts first time
  document.addEventListener('pointerdown', ()=> ensureAudio(), { once:true });
}

/* ---------- misc helpers ---------- */
function hexToRgba(hex,a){ const c=hex.replace('#',''); const num=parseInt(c,16); const r=(num>>16)&255,g=(num>>8)&255,b=num&255; return `rgba(${r},${g},${b},${a})`; }
function getCurrentTierIndex(){ let idx=0; for(let i=0;i<TIERS.length;i++){ if(state.fuel >= TIERS[i].threshold) idx = i; else break; } return Math.min(idx, TIERS.length-1); }

boot(); // start

// expose small utilities for debugging
window._state = state;
window._save = saveGame;
window._spawnStar = spawnShootingStar;

</script>
</body>
</html>
