<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rocket Clicker â€” Polished Edition</title>
<style>
  :root{
    --sky-top: #071634;
    --sky-bottom: #020417;
    --panel: rgba(255,255,255,0.03);
    --accent: #ff8a2b;
    --muted: #9fb0c8;
  }
  *{box-sizing:border-box;font-family:Inter,Segoe UI,system-ui,Arial,Helvetica,sans-serif}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--sky-top),var(--sky-bottom));color:#eaf6ff}
  .app{display:grid;grid-template-columns:1fr 360px;gap:18px;max-width:1280px;margin:18px auto;padding:18px}
  header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:20px}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:14px;padding:14px;box-shadow:0 12px 40px rgba(0,0,0,0.55)}
  .left{padding:12px}
  .sky{height:680px;border-radius:12px;padding:0;position:relative;overflow:hidden}
  /* star layers for parallax */
  .star-layer{position:absolute;inset:0;pointer-events:none;overflow:hidden}
  .star{position:absolute;border-radius:50%;background:rgba(255,255,255,0.9);filter:blur(.3px)}
  /* nebula canvas sits under rocket but above far stars */
  canvas#nebula{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;mix-blend-mode:screen;opacity:0.12}
  /* planet decorations */
  .planet{position:absolute;border-radius:50%;pointer-events:none;filter:blur(2px);opacity:0.11}
  /* rocket container */
  .rocket-wrap{position:absolute;left:50%;bottom:8%;transform:translateX(-50%) translateY(0);transition:transform 0.42s cubic-bezier(.2,.9,.2,1);will-change:transform}
  .rocket-stage{position:absolute;left:50%;bottom:0;transform:translateX(-50%) translateY(10px);opacity:0;transition:opacity 320ms ease, transform 320ms ease;will-change:opacity,transform}
  .rocket-stage.active{opacity:1;transform:translateX(-50%) translateY(0)}
  .rocket-box{width:220px;height:360px;display:block;pointer-events:none}
  .flame{position:absolute;left:50%;bottom:-28px;transform:translateX(-50%) scaleY(1);transform-origin:50% 0%;transition:transform 120ms,opacity 120ms}
  /* morph animation helpers */
  .morph-out{opacity:0;transform:translateX(-50%) scale(0.94); transition:opacity 320ms, transform 320ms}
  .morph-in{opacity:1;transform:translateX(-50%) scale(1.06); transition:opacity 320ms, transform 320ms}
  /* idle sway */
  .idle-sway{animation:idle 3.6s ease-in-out infinite}
  @keyframes idle{0%{transform:translateX(-50%) translateY(0) rotate(-0.8deg)}50%{transform:translateX(-50%) translateY(-5px) rotate(0.8deg)}100%{transform:translateX(-50%) translateY(0) rotate(-0.8deg)}}
  /* HUD */
  .hud{margin-top:10px;display:flex;gap:12px;align-items:center}
  .fuel-counter{font-weight:800;font-size:20px}
  .muted{color:var(--muted);font-size:13px}
  .shop{display:flex;flex-direction:column;gap:10px}
  .store-list{max-height:420px;overflow:auto;padding-right:6px}
  .item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:12px;background:rgba(255,255,255,0.02);cursor:pointer;transition:transform .12s}
  .item:hover{transform:translateY(-4px)}
  .item.locked{opacity:0.44;cursor:not-allowed;transform:none}
  .name{font-weight:700}
  .num{color:var(--muted)}
  button{background:linear-gradient(180deg,#143444,#092528);border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:#cfeefb;cursor:pointer}
  #fxLayer{position:absolute;inset:0;pointer-events:none}
  .spark{position:absolute;border-radius:50%;pointer-events:none;filter:blur(.6px)}
  .trail{position:absolute;pointer-events:none;filter:blur(1.6px);opacity:0.95;border-radius:4px}
  .shoot{position:absolute;pointer-events:none;border-radius:50%;box-shadow:0 0 12px rgba(255,200,150,0.6)}
  .hit-flash{position:absolute;inset:0;pointer-events:none;background:rgba(255,255,255,0);transition:background 180ms}
  .shake{animation:shake 320ms linear}
  @keyframes shake{0%{transform:translate(0,0)}20%{transform:translate(-6px,4px)}40%{transform:translate(6px,-4px)}60%{transform:translate(-4px,2px)}80%{transform:translate(4px,-2px)}100%{transform:translate(0,0)}}
  footer{grid-column:1/-1;margin-top:8px;text-align:center;color:var(--muted);font-size:13px}
  .locked-tag{font-size:12px;color:#ffd7b3;background:rgba(0,0,0,0.24);padding:4px 8px;border-radius:8px}
  @media (max-width:920px){.app{grid-template-columns:1fr}.sky{height:520px}}
</style>
</head>
<body>
  <div class="app" id="appRoot">
    <header>
      <h1>ðŸš€ Rocket Clicker â€” Polished Edition</h1>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="muted">Fuel: <span id="fuelTop">0</span></div>
        <button id="saveBtn">Save</button>
        <button id="resetBtn">Reset</button>
      </div>
    </header>

    <main class="left panel">
      <div class="sky" id="sky">
        <!-- layers -->
        <div class="star-layer" id="stars-far"></div>
        <canvas id="nebula"></canvas>
        <div class="star-layer" id="stars-mid"></div>
        <div class="star-layer" id="stars-near"></div>

        <!-- planets (appear later) -->
        <div id="planets"></div>

        <!-- rocket holder -->
        <div class="rocket-wrap idle-sway" id="rocketWrap" style="touch-action:none">
          <!-- multiple stages as separate elements for nicer morphing -->
          <!-- Stage 0: base -->
          <div class="rocket-stage" id="stage-0">
            <div class="rocket-box" aria-hidden="true">
              <svg viewBox="0 0 200 320" class="rocket-svg">
                <!-- base hull -->
                <defs>
                  <linearGradient id="g_body0" x1="0" x2="0" y1="0" y2="1">
                    <stop offset="0%" stop-color="#fff7ef"/><stop offset="100%" stop-color="#cfeffb" stop-opacity="0.06"/>
                  </linearGradient>
                  <linearGradient id="g_nose0" x1="0" x2="1">
                    <stop offset="0%" stop-color="#ffb07a"/><stop offset="100%" stop-color="#ff6b6b"/>
                  </linearGradient>
                </defs>
                <g transform="translate(20,12)">
                  <ellipse cx="80" cy="250" rx="36" ry="12" fill="#071822" opacity="0.12"/>
                  <rect x="48" y="40" width="64" height="140" rx="18" fill="url(#g_body0)" stroke="#9edfff" stroke-opacity="0.06"/>
                  <path d="M80 8 C64 36,96 36,80 8 Z" fill="url(#g_nose0)"/>
                  <rect x="30" y="86" width="20" height="56" rx="6" fill="#0f2a3a"/>
                  <rect x="112" y="86" width="20" height="56" rx="6" fill="#0f2a3a"/>
                  <circle cx="80" cy="104" r="12" fill="#001a22" stroke="#bfe7ff" stroke-opacity="0.12"/>
                </g>
              </svg>
            </div>
            <div class="flame" id="flame-0">
              <svg viewBox="0 0 48 80" width="76" height="120">
                <g>
                  <path d="M24 2 C12 24,10 44,24 70 C38 44,36 24,24 2 Z" fill="#ffd7a6"/>
                  <path d="M24 18 C18 36,16 44,24 58 C32 44,30 36,24 18 Z" fill="#ff6b18"/>
                </g>
              </svg>
            </div>
          </div>

          <!-- Stage 1: mk2 -->
          <div class="rocket-stage" id="stage-1">
            <div class="rocket-box">
              <svg viewBox="0 0 220 340" class="rocket-svg">
                <defs>
                  <linearGradient id="g_body1" x1="0" x2="0" y1="0" y2="1">
                    <stop offset="0%" stop-color="#fff7f1"/><stop offset="100%" stop-color="#ffd6c0" stop-opacity="0.06"/>
                  </linearGradient>
                </defs>
                <g transform="translate(18,8)">
                  <ellipse cx="95" cy="270" rx="44" ry="14" fill="#071822" opacity="0.12"/>
                  <rect x="52" y="34" width="86" height="150" rx="20" fill="url(#g_body1)" stroke="#ffb78a" stroke-opacity="0.06"/>
                  <path d="M95 6 C74 40,116 40,95 6 Z" fill="#ff5a7a"/>
                  <circle cx="95" cy="112" r="14" fill="#021827" stroke="#ffd7b3" stroke-opacity="0.12"/>
                  <!-- small animated detail -->
                  <rect x="36" y="124" width="20" height="64" rx="8" fill="#0b2a3b"/>
                  <rect x="150" y="124" width="20" height="64" rx="8" fill="#0b2a3b"/>
                </g>
              </svg>
            </div>
            <div class="flame" id="flame-1">
              <svg viewBox="0 0 56 90" width="88" height="140">
                <g>
                  <path d="M28 2 C12 26,10 44,28 78 C46 44,44 26,28 2 Z" fill="#ffe0c0"/>
                  <path d="M28 16 C22 34,20 44,28 64 C36 44,34 34,28 16 Z" fill="#ff7a18"/>
                </g>
              </svg>
            </div>
          </div>

          <!-- Stage 2: mk3 -->
          <div class="rocket-stage" id="stage-2">
            <div class="rocket-box">
              <svg viewBox="0 0 240 360" class="rocket-svg">
                <defs><linearGradient id="g_body2" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#f9fdff"/><stop offset="100%" stop-color="#dbf7ff" stop-opacity="0.06"/></linearGradient></defs>
                <g transform="translate(20,6)">
                  <ellipse cx="100" cy="290" rx="48" ry="15" fill="#071822" opacity="0.12"/>
                  <rect x="58" y="30" width="84" height="168" rx="22" fill="url(#g_body2)" stroke="#aef2ff" stroke-opacity="0.08"/>
                  <path d="M100 8 C76 46,124 46,100 8 Z" fill="#9a7bff"/>
                  <circle cx="100" cy="118" r="16" fill="#021827" stroke="#cfefff" stroke-opacity="0.12"/>
                  <path d="M40 150 L12 196 L40 168 Z" fill="#0f3446"/>
                  <path d="M160 150 L188 196 L160 168 Z" fill="#0f3446"/>
                </g>
              </svg>
            </div>
            <div class="flame" id="flame-2">
              <svg viewBox="0 0 64 96" width="100" height="160">
                <g>
                  <path d="M32 2 C14 32,12 56,32 96 C52 56,50 32,32 2 Z" fill="#fff3d8"/>
                  <path d="M32 20 C24 40,22 52,32 78 C42 52,40 40,32 20 Z" fill="#ff7a18"/>
                </g>
              </svg>
            </div>
          </div>

          <!-- Stage 3..11 (late and flashy variants) - we'll include several decorative variants -->
          <!-- Stage 3 -->
          <div class="rocket-stage" id="stage-3">
            <div class="rocket-box">
              <svg viewBox="0 0 260 380" class="rocket-svg">
                <defs>
                  <linearGradient id="g_body3" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#fff9f3"/><stop offset="100%" stop-color="#ffd7b3" stop-opacity="0.06"/></linearGradient>
                </defs>
                <g transform="translate(24,6)">
                  <ellipse cx="120" cy="300" rx="54" ry="16" fill="#071822" opacity="0.12"/>
                  <rect x="70" y="28" width="100" height="178" rx="24" fill="url(#g_body3)" stroke="#ffdbb3" stroke-opacity="0.07"/>
                  <path d="M120 6 C92 56,148 56,120 6 Z" fill="#ffd37a"/>
                  <circle cx="120" cy="130" r="18" fill="#041827" stroke="#fff1d6" stroke-opacity="0.14"/>
                  <!-- solar panels -->
                  <rect x="20" y="136" width="44" height="84" rx="4" fill="#0b2a40"/>
                  <rect x="176" y="136" width="44" height="84" rx="4" fill="#0b2a40"/>
                </g>
              </svg>
            </div>
            <div class="flame" id="flame-3">
              <svg viewBox="0 0 72 110" width="110" height="180">
                <g>
                  <path d="M36 2 C12 44,10 72,36 110 C62 72,60 44,36 2 Z" fill="#fff4dd"/>
                  <path d="M36 20 C28 46,26 60,36 92 C46 60,44 46,36 20 Z" fill="#ff6b18"/>
                </g>
              </svg>
            </div>
          </div>

          <!-- Stage 4 -->
          <div class="rocket-stage" id="stage-4">
            <div class="rocket-box">
              <svg viewBox="0 0 280 420" class="rocket-svg">
                <defs><linearGradient id="g_body4" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#fff3ff"/><stop offset="100%" stop-color="#f0f9ff" stop-opacity="0.06"/></linearGradient></defs>
                <g transform="translate(24,10)">
                  <ellipse cx="140" cy="330" rx="62" ry="18" fill="#071822" opacity="0.12"/>
                  <rect x="84" y="32" width="112" height="206" rx="26" fill="url(#g_body4)" stroke="#ffd7f0" stroke-opacity="0.06"/>
                  <path d="M140 6 C106 68,174 68,140 6 Z" fill="#ffd0ff"/>
                  <circle cx="140" cy="150" r="20" fill="#021827" stroke="#fff6ff" stroke-opacity="0.14"/>
                  <!-- extra animated modules -->
                  <g transform="translate(24,160)"><rect x="0" y="0" width="56" height="100" rx="6" fill="#0b2a40"/></g>
                  <g transform="translate(200,160)"><rect x="0" y="0" width="56" height="100" rx="6" fill="#0b2a40"/></g>
                </g>
              </svg>
            </div>
            <div class="flame" id="flame-4">
              <svg viewBox="0 0 84 120" width="126" height="200">
                <g>
                  <path d="M42 2 C12 54,10 88,42 120 C74 88,72 54,42 2 Z" fill="#fff4f0"/>
                  <path d="M42 24 C32 54,30 70,42 102 C54 70,52 54,42 24 Z" fill="#ff4a18"/>
                </g>
              </svg>
            </div>
          </div>

          <!-- Stage 5 (legendary variant 1) -->
          <div class="rocket-stage" id="stage-5">
            <div class="rocket-box">
              <svg viewBox="0 0 300 440" class="rocket-svg">
                <defs><linearGradient id="g_body5" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#fffefc"/><stop offset="100%" stop-color="#eaf8ff" stop-opacity="0.06"/></linearGradient></defs>
                <g transform="translate(28,12)">
                  <ellipse cx="150" cy="350" rx="70" ry="20" fill="#071822" opacity="0.12"/>
                  <rect x="98" y="36" width="124" height="220" rx="28" fill="url(#g_body5)" stroke="#ffe0a8" stroke-opacity="0.06"/>
                  <path d="M150 6 C112 80,188 80,150 6 Z" fill="#ffd37a"/>
                  <circle cx="150" cy="164" r="22" fill="#021827" stroke="#fff6d8" stroke-opacity="0.14"/>
                  <!-- spinning ring decorative -->
                  <g transform="translate(70,220)"><rect x="0" y="0" width="160" height="18" rx="9" fill="#162f3f" opacity="0.7"/></g>
                </g>
              </svg>
            </div>
            <div class="flame" id="flame-5">
              <svg viewBox="0 0 100 140" width="150" height="220">
                <g>
                  <path d="M50 2 C18 68,16 108,50 140 C84 108,82 68,50 2 Z" fill="#fff8e8"/>
                  <path d="M50 28 C38 64,36 84,50 116 C64 84,62 64,50 28 Z" fill="#ff6b18"/>
                </g>
              </svg>
            </div>
          </div>

          <!-- We'll reuse stage-5 look for later stages but morph effects and flame color will vary.
               For simplicity in this single file we'll supply up to stage-8 explicit elements, then reuse stage-5 visually for very late stages (appearance cycles). -->
          <div class="rocket-stage" id="stage-6"><!-- fancy alt --></div>
          <div class="rocket-stage" id="stage-7"></div>
          <div class="rocket-stage" id="stage-8"></div>
        </div>

        <!-- fx layer and hit flash -->
        <div id="fxLayer"></div>
        <div class="hit-flash" id="hitFlash"></div>
      </div>

      <div class="hud panel" style="margin-top:12px;display:flex;align-items:center;justify-content:space-between">
        <div>
          <div class="fuel-counter" id="fuel">0</div>
          <div class="muted small">fuel units</div>
        </div>
        <div style="text-align:right">
          <div class="muted small">Per Click: <span id="perClick">1</span></div>
          <div class="muted small">Per Second: <span id="perSecond">0</span></div>
        </div>
      </div>
    </main>

    <aside class="panel">
      <h3 style="margin-top:0">Launch Bay â€” Shop</h3>
      <div class="muted small">Engineers (autoclickers), Thrusters (click boosts), Labs (multipliers).</div>
      <div style="height:12px"></div>
      <div class="shop">
        <div class="store-list panel" id="storeList"></div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div class="muted small">Rocket Altitude</div>
          <div id="altitude" class="fuel-counter">0%</div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div class="muted small">Prestige</div>
          <div id="prestigeWrap"><button id="prestigeBtn" style="display:none">Prestige (1,000,000)</button></div>
        </div>
      </div>
    </aside>

    <footer class="muted small">Tip: Click anywhere to glide to that location and dodge shooting stars. Press <strong>Space</strong> to click (gain fuel).</footer>
  </div>

<script>
/* ---------- Polished Rocket Clicker (full game) ---------- */

/* -----------------------
   GAME STATE
   ----------------------- */
const state = {
  fuel: 0,
  perClick: 1,
  perSecond: 0,
  lastTick: Date.now(),
  clickBurst: 0,
  prestige: 0,
  // rocket movement
  rocket: { x:0, y:0, tx: null, ty: null, vx:0, vy:0, speed: 880, easing: 0.14 },
  // shooting star objects
  stars: [],
  lastStarSpawn: 0,
  // progression items (15)
  items: [
    { id:'engineer', name:'Engineer', desc:'Skilled engineers automate clicks.', baseCost:12, cps:0.18, cpc:0, qty:0 },
    { id:'robot', name:'Junior Robot', desc:'Basic automation bots.', baseCost:48, cps:0.9, cpc:0, qty:0 },
    { id:'senior', name:'Senior Engineer', desc:'Fast production.', baseCost:240, cps:3.6, cpc:0, qty:0 },
    { id:'thruster', name:'Thruster', desc:'Better manual click power.', baseCost:56, cps:0, cpc:1.8, qty:0 },
    { id:'adv_thruster', name:'Advanced Thruster', desc:'Strong manual power.', baseCost:420, cps:0, cpc:7, qty:0 },
    { id:'lab', name:'Research Lab', desc:'Multiplicative thruster boost.', baseCost:950, cps:0, cpc:0, qty:0, type:'mult', mult:1.45 },
    { id:'sat', name:'Satellite Relay', desc:'Passive remote feed.', baseCost:1400, cps:12, cpc:0, qty:0 },
    { id:'ai', name:'AI Systems', desc:'Smart optimization (big passive).', baseCost:7200, cps:72, cpc:0, qty:0 },
    { id:'factory', name:'Factory', desc:'Mass produce parts.', baseCost:32000, cps:320, cpc:0, qty:0 },
    { id:'megafactory', name:'Mega Factory', desc:'Large-scale production.', baseCost:220000, cps:1900, cpc:0, qty:0 },
    { id:'orbital', name:'Orbital Platform', desc:'Advanced passive power.', baseCost:1_500_000, cps:12000, cpc:0, qty:0 },
    { id:'colony', name:'Lunar Colony', desc:'Expand production off-world.', baseCost:7_500_000, cps:56000, cpc:0, qty:0 },
    { id:'dyson', name:'Dyson Swarm', desc:'Enormous passive power.', baseCost:45_000_000, cps:350_000, cpc:0, qty:0 },
    { id:'quantum', name:'Quantum Labs', desc:'Multiply thrusters.', baseCost:180_000_000, cps:0, cpc:0, qty:0, type:'mult', mult:2.0 },
    { id:'singularity', name:'Singularity Core', desc:'Ultimate passive engine.', baseCost:1_000_000_000, cps:2_000_000, cpc:0, qty:0 }
  ]
};

/* -----------------------
   DOM REFERENCES
   ----------------------- */
const fuelEl = document.getElementById('fuel');
const fuelTopEl = document.getElementById('fuelTop');
const perClickEl = document.getElementById('perClick');
const perSecondEl = document.getElementById('perSecond');
const storeList = document.getElementById('storeList');
const sky = document.getElementById('sky');
const rocketWrap = document.getElementById('rocketWrap');
const fxLayer = document.getElementById('fxLayer');
const hitFlash = document.getElementById('hitFlash');
const altitudeEl = document.getElementById('altitude');
const prestigeBtn = document.getElementById('prestigeBtn');

/* -----------------------
   UTILITIES
   ----------------------- */
function fmt(n){
  if(n < 1000) return Math.round(n*100)/100;
  const si=['','K','M','B','T','Qa','Qi','Sx','Sp'];
  let i=0; while(n>=1000 && i<si.length-1){ n/=1000; i++; } return (Math.round(n*100)/100) + si[i];
}
function now(){ return Date.now(); }

/* -----------------------
   COSTS & SHOP
   ----------------------- */
function cost(item){ return Math.ceil(item.baseCost * Math.pow(1.135, item.qty)); }
function sortedItems(){ return state.items.map(it=>({ ...it, cost: cost(it) })).sort((a,b)=>a.cost-b.cost); }
function unlocked(i){ if(i===0) return true; return state.items[i-1].qty > 0; }

/* -----------------------
   RECALC PRODUCTION
   ----------------------- */
function recalc(){
  let pc = 1; let ps = 0;
  state.items.forEach(it=>{
    if(it.cpc) pc += it.cpc * it.qty;
    if(it.cps) ps += it.cps * it.qty;
    if(it.type === 'mult' && it.qty > 0) pc *= Math.pow(it.mult, it.qty);
  });
  state.perClick = pc; state.perSecond = ps;
}

/* -----------------------
   RENDER STORE & UI
   ----------------------- */
function renderStore(){
  storeList.innerHTML = '';
  const sorted = sortedItems();
  sorted.forEach(si=>{
    const originalIndex = state.items.findIndex(x=>x.id===si.id);
    const ok = unlocked(originalIndex);
    const el = document.createElement('div');
    el.className = 'item' + (ok ? '' : ' locked');
    el.innerHTML = `<div style="display:flex;gap:12px;align-items:center"><div><div class="name">${si.name}</div><div class="muted small">${si.desc}</div></div></div><div style="text-align:right"><div class="num">${ ok ? fmt(si.cost) : '<span class="locked-tag">Locked</span>' }</div><div class="muted small">Owned: ${si.qty}</div></div>`;
    el.addEventListener('click', ()=>{ if(!ok){ lockedFeedback(); return; } buy(si.id); });
    storeList.appendChild(el);
  });
}
function renderUI(){
  fuelEl.textContent = fmt(state.fuel);
  fuelTopEl.textContent = Math.round(state.fuel);
  perClickEl.textContent = fmt(state.perClick);
  perSecondEl.textContent = fmt(state.perSecond);
  const alt = Math.min(99, Math.sqrt(state.fuel / (1500 + state.prestige*600)) * 100);
  altitudeEl.textContent = Math.round(alt) + '%';
  // vertical rocket offset (affects actual DOM transform)
  const bottomOffset = -(alt/1.6);
  rocketWrap.style.transform = `translateX(-50%) translateY(${bottomOffset}px)`;
  renderStore();
  applyStage();
  if(state.fuel >= 1_000_000) prestigeBtn.style.display = 'inline-block'; else prestigeBtn.style.display = 'none';
}

/* -----------------------
   BUY ITEM
   ----------------------- */
function buy(id){
  const it = state.items.find(x=>x.id===id);
  const c = cost(it);
  if(state.fuel >= c){
    state.fuel -= c; it.qty++; recalc(); spawnPopup(`+ ${it.name}`); spawnSparkles(20); renderUI();
  } else lockedFeedback();
}
function lockedFeedback(){
  rocketWrap.style.transition = 'transform .08s';
  rocketWrap.style.transform = 'translateX(-50%) translateY(-8px)';
  setTimeout(()=> rocketWrap.style.transform = 'translateX(-50%)', 120);
  setTimeout(()=> rocketWrap.style.transition = '', 220);
}

/* -----------------------
   CLICK / EXHAUST / SPARKLES
   ----------------------- */
function doClick(n=1){
  state.clickBurst = Math.min(8, state.clickBurst + 1);
  state.fuel += state.perClick * n;
  spawnExhaust(); spawnSparkles(14); renderUI();
}
function spawnSparkles(cnt=12){
  for(let i=0;i<cnt;i++){
    const s = document.createElement('div'); s.className='spark';
    const layerRect = fxLayer.getBoundingClientRect();
    const rx = rocketWrap.getBoundingClientRect().left + rocketWrap.getBoundingClientRect().width/2 - layerRect.left;
    const ry = rocketWrap.getBoundingClientRect().top + rocketWrap.getBoundingClientRect().height - layerRect.top - 20;
    s.style.left = (rx + (Math.random()*64-32)) + 'px'; s.style.top = (ry + (Math.random()*32-12)) + 'px';
    const size = 4 + Math.random()*10; s.style.width = s.style.height = size + 'px';
    s.style.background = `radial-gradient(circle, #ffd9b3, rgba(255,120,30,0.7))`;
    fxLayer.appendChild(s);
    const dx = (Math.random()*180-90); const dy = (80 + Math.random()*120);
    s.animate([{ transform:'translate(0,0) scale(1)', opacity:1 }, { transform:`translate(${dx}px, -${dy}px) scale(0.2)`, opacity:0 }], { duration:700 + Math.random()*500, easing:'cubic-bezier(.2,.9,.2,1)' });
    setTimeout(()=> s.remove(), 1200);
  }
}
function spawnExhaust(){
  const rect = fxLayer.getBoundingClientRect(); const wrap = rocketWrap.getBoundingClientRect();
  const cx = wrap.left + wrap.width/2 - rect.left; const cy = wrap.top + wrap.height - rect.top - 20;
  for(let i=0;i<10;i++){
    const p = document.createElement('div'); p.className='trail';
    const size = 6 + Math.random()*14; p.style.width = size+'px'; p.style.height = size+'px';
    p.style.left = (cx + (Math.random()*48-24)) + 'px'; p.style.top = (cy + (Math.random()*20-8)) + 'px';
    p.style.background = `radial-gradient(circle,#ffd6a0, rgba(255,120,30,0.6))`;
    fxLayer.appendChild(p);
    const angle = Math.PI + (Math.random()-0.5)*1.3; const dist = 40 + Math.random()*160; const dx = Math.cos(angle)*dist; const dy = Math.sin(angle)*dist;
    p.animate([{ transform:'translate(0,0) scale(1)', opacity:1 }, { transform:`translate(${dx}px, ${dy}px) scale(0.2)`, opacity:0 }], { duration:600 + Math.random()*600, easing:'cubic-bezier(.2,.9,.2,1)' });
    setTimeout(()=> p.remove(), 1100);
  }
}

/* -----------------------
   SAVE / LOAD
   ----------------------- */
function save(){
  try{
    const s = { fuel: state.fuel, prestige: state.prestige, items: state.items.map(it=>({id:it.id,qty:it.qty})) };
    localStorage.setItem('rocket_polished_v1', JSON.stringify(s));
    spawnPopup('Saved');
  }catch(e){ console.error(e); }
}
function load(){
  try{
    const raw = localStorage.getItem('rocket_polished_v1');
    if(!raw) return;
    const s = JSON.parse(raw); state.fuel = s.fuel || 0; state.prestige = s.prestige || 0;
    if(s.items && Array.isArray(s.items)) s.items.forEach(si=>{ const it = state.items.find(x=>x.id===si.id); if(it) it.qty = si.qty || 0; });
    recalc(); renderUI(); spawnPopup('Loaded');
  }catch(e){ console.error(e); }
}

/* -----------------------
   TICK (passive income)
   ----------------------- */
function tick(){
  const nowMs = now(); const dt = (nowMs - state.lastTick)/1000; state.lastTick = nowMs;
  if(state.perSecond > 0) state.fuel += state.perSecond * dt;
  state.clickBurst = Math.max(0, state.clickBurst - dt*4.5);
  updateFlame(); renderUI(); updateRocket(dt); updateShootingStars(dt);
}

/* -----------------------
   STAGE / SKY LOGIC & MORPH
   ----------------------- */
const stages = [
  { id:'base', min:0, max:2499, skyTop:'#071634', skyBottom:'#020417' },
  { id:'mk2', min:2500, max:4999, skyTop:'#081b2b', skyBottom:'#020512' },
  { id:'mk3', min:5000, max:9999, skyTop:'#160a2f', skyBottom:'#030014' },
  { id:'mk4', min:10000, max:14999, skyTop:'#0b0720', skyBottom:'#00010a' },
  { id:'mk5', min:15000, max:19999, skyTop:'#0e0618', skyBottom:'#00000b' },
  { id:'mk6', min:20000, max:29999, skyTop:'#050012', skyBottom:'#000009' },
  { id:'mk7', min:30000, max:49999, skyTop:'#00000b', skyBottom:'#000007' },
  { id:'mk8', min:50000, max:74999, skyTop:'#00000a', skyBottom:'#000006' },
  { id:'legend', min:75000, max:Infinity, skyTop:'#000007', skyBottom:'#000002' }
];
let currentStage = -1;
function computeStage(fuel){
  for(let i=stages.length-1;i>=0;i--){ if(fuel >= stages[i].min) return i; }
  return 0;
}
function applyStage(){
  const idx = computeStage(state.fuel);
  if(idx !== currentStage){
    // morph: fade out old stage then fade in new
    const prevStage = currentStage;
    currentStage = idx;
    morphToStage(idx);
  }
  // sky color
  const top = stages[Math.min(idx, stages.length-1)].skyTop;
  const bottom = stages[Math.min(idx, stages.length-1)].skyBottom;
  document.documentElement.style.setProperty('--sky-top', top);
  document.documentElement.style.setProperty('--sky-bottom', bottom);
}

/* morph animation */
function morphToStage(idx){
  // hide all then show the correct one with fade+scale
  const stagesEls = Array.from(document.querySelectorAll('.rocket-stage'));
  stagesEls.forEach(el => { el.classList.remove('active'); el.classList.remove('morph-in'); el.classList.remove('morph-out'); });
  // if idx maps > available specific DOM stages, reuse stage-5 as fanciful stage
  let domId = (idx <= 5) ? `stage-${idx}` : 'stage-5';
  const el = document.getElementById(domId);
  if(!el) return;
  // animate
  el.classList.add('morph-out'); // start hidden
  requestAnimationFrame(()=> {
    // small delay to allow CSS changes to apply
    el.classList.add('active');
    el.classList.remove('morph-out');
    el.classList.add('morph-in');
    setTimeout(()=> el.classList.remove('morph-in'), 420);
  });
  spawnSparkles(28);
}

/* -----------------------
   Stars, Nebula & Planets
   ----------------------- */
function makeStarLayers(){
  const far = document.getElementById('stars-far');
  const mid = document.getElementById('stars-mid');
  const near = document.getElementById('stars-near');
  far.innerHTML=''; mid.innerHTML=''; near.innerHTML='';
  // far: many faint stars
  for(let i=0;i<110;i++){
    const s = document.createElement('div'); s.className='star';
    s.style.left = Math.random()*100 + '%'; s.style.top = Math.random()*100 + '%';
    const r = 0.6 + Math.random()*1.6; s.style.width = s.style.height = r + 'px'; s.style.opacity = 0.12 + Math.random()*0.6;
    // slow drift using CSS animation (randomize duration)
    s.animate([{ transform:'translateY(-4vh)' }, { transform:'translateY(4vh)' }], { duration: 60000 + Math.random()*120000, iterations: Infinity });
    far.appendChild(s);
  }
  for(let i=0;i<70;i++){
    const s = document.createElement('div'); s.className='star';
    s.style.left = Math.random()*100 + '%'; s.style.top = Math.random()*100 + '%';
    const r = 1 + Math.random()*2.4; s.style.width = s.style.height = r + 'px'; s.style.opacity = 0.18 + Math.random()*0.7;
    s.animate([{ transform:'translateY(-3vh)' }, { transform:'translateY(3vh)' }], { duration: 42000 + Math.random()*80000, iterations: Infinity });
    mid.appendChild(s);
  }
  for(let i=0;i<36;i++){
    const s = document.createElement('div'); s.className='star';
    s.style.left = Math.random()*100 + '%'; s.style.top = Math.random()*100 + '%';
    const r = 1.6 + Math.random()*3.2; s.style.width = s.style.height = r + 'px'; s.style.opacity = 0.28 + Math.random()*0.8;
    s.animate([{ transform:'translateY(-2vh)' }, { transform:'translateY(2vh)' }], { duration: 32000 + Math.random()*52000, iterations: Infinity });
    near.appendChild(s);
  }
}

function setupNebulaCanvas(){
  const canvas = document.getElementById('nebula'); const ctx = canvas.getContext('2d');
  function resize(){ const r = sky.getBoundingClientRect(); canvas.width = r.width; canvas.height = r.height; }
  resize(); window.addEventListener('resize', resize);
  // create blobs
  const blobs = [];
  const colors = ['#6f46ff','#2ab6ff','#ff8db3','#8effc6'];
  for(let i=0;i<6;i++){
    blobs.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height*0.8, r: 180+Math.random()*320, color: colors[i%colors.length], vx:(Math.random()-0.5)*8, vy:(Math.random()-0.5)*1.2, alpha: 0.06 + Math.random()*0.12 });
  }
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    blobs.forEach(b=>{
      b.x += b.vx*0.06; b.y += b.vy*0.06;
      if(b.x > canvas.width + b.r) b.x = -b.r; if(b.x < -b.r) b.x = canvas.width + b.r;
      const g = ctx.createRadialGradient(b.x, b.y, b.r*0.02, b.x, b.y, b.r);
      g.addColorStop(0, hexToRgba(b.color, b.alpha*1.5));
      g.addColorStop(0.45, hexToRgba(b.color, b.alpha));
      g.addColorStop(1, hexToRgba('#000000', 0));
      ctx.globalCompositeOperation = 'lighter';
      ctx.fillStyle = g; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
    });
    requestAnimationFrame(draw);
  }
  draw();
}
function hexToRgba(hex,a){ const c=hex.replace('#',''); const num = parseInt(c,16); const r=(num>>16)&255,g=(num>>8)&255,b=num&255; return `rgba(${r},${g},${b},${a})`; }

/* -----------------------
   SHOOTING STARS (improved) - spawn & update & collisions
   ----------------------- */
const starTypes = [
  { name:'white', color:'#fff6d6', speedR:[420,720], sizeR:[6,10], penalty:0.065, trail:'#ffd8a8' },
  { name:'blue',  color:'#a6e0ff', speedR:[640,980], sizeR:[4,8], penalty:0.05, trail:'#a6e6ff' },
  { name:'red',   color:'#ffb3b3', speedR:[220,420], sizeR:[10,18], penalty:0.12, trail:'#ffb3b3' },
  { name:'green', color:'#bfffd6', speedR:[480,760], sizeR:[5,9], penalty:0.045, trail:'#bfffd6' }
];

function spawnStar(){
  const rect = sky.getBoundingClientRect();
  // choose type weighted
  const r = Math.random();
  let t = starTypes[0];
  if(r < 0.6) t = starTypes[0]; else if(r < 0.82) t = starTypes[1]; else if(r < 0.95) t = starTypes[2]; else t = starTypes[3];
  // choose spawn edge (top or sides)
  let sx, sy, angle;
  if(Math.random() < 0.7){
    sx = Math.random()*rect.width*0.9 + rect.width*0.05;
    sy = -20;
    angle = (30 + Math.random()*60) * (Math.random() < 0.5 ? 1 : -1);
    if(Math.random()<0.5) angle = 10 + Math.random()*40; else angle = 140 + Math.random()*40;
  } else {
    if(Math.random() < 0.5){ sx = -40; sy = Math.random()*rect.height*0.7 + 20; angle = 10 + Math.random()*60; } 
    else { sx = rect.width + 40; sy = Math.random()*rect.height*0.7 + 20; angle = 200 + Math.random()*60; }
  }
  const speed = t.speedR[0] + Math.random()*(t.speedR[1]-t.speedR[0]); // px/s
  const size = t.sizeR[0] + Math.random()*(t.sizeR[1]-t.sizeR[0]);
  const rad = angle * Math.PI/180;
  const vx = Math.cos(rad)*speed, vy = Math.sin(rad)*speed;
  // DOM elements
  const el = document.createElement('div'); el.className='shoot'; el.style.width = size+'px'; el.style.height = size+'px';
  el.style.left = sx + 'px'; el.style.top = sy + 'px';
  el.style.background = t.color; el.style.boxShadow = `0 0 ${Math.max(6,size)}px ${t.trail}`;
  const trail = document.createElement('div'); trail.className='trail';
  trail.style.left = sx + 'px'; trail.style.top = sy + 'px'; trail.style.width = (size*5) + 'px'; trail.style.height = Math.max(4, size/1.6) + 'px';
  trail.style.background = `linear-gradient(90deg, ${t.trail}, rgba(0,0,0,0))`; trail.style.transformOrigin = '0 50%';
  fxLayer.appendChild(trail); fxLayer.appendChild(el);
  const obj = { el, trail, x:sx, y:sy, vx, vy, size, type: t, birth: now() };
  state.stars.push(obj);
}

/* update stars, collision with rocket (circular hitbox around rocket center) */
function updateShootingStars(dt){
  const rect = sky.getBoundingClientRect();
  // spawn rare: every 12-28s
  const tSince = now() - state.lastStarSpawn;
  const spawnDelay = 12000 + Math.random()*16000;
  if(tSince > spawnDelay){
    state.lastStarSpawn = now();
    // spawn 1-2
    spawnStar(); if(Math.random() < 0.45) setTimeout(spawnStar, 120 + Math.random()*480);
  }
  // move & check
  for(let i = state.stars.length-1; i >= 0; i--){
    const s = state.stars[i];
    s.x += s.vx * dt; s.y += s.vy * dt;
    // update DOM
    s.el.style.left = s.x + 'px'; s.el.style.top = s.y + 'px';
    const deg = Math.atan2(s.vy, s.vx) * 180/Math.PI; s.trail.style.transform = `rotate(${deg}deg) translateX(${-s.size*1.8}px)`;
    s.trail.style.left = s.x + 'px'; s.trail.style.top = s.y + 'px';
    // collision: compute rocket center in fxLayer coordinates
    const rocketRect = rocketWrap.getBoundingClientRect();
    const fxRect = fxLayer.getBoundingClientRect();
    const rcx = rocketRect.left + rocketRect.width/2 - fxRect.left;
    const rcy = rocketRect.top + rocketRect.height/2 - fxRect.top;
    const dx = s.x - rcx; const dy = s.y - rcy; const dist = Math.hypot(dx,dy);
    const hitRadius = Math.max(28, rocketRect.width*0.22) + s.size*0.6; // fair hitbox (smaller than long trail)
    if(dist < hitRadius){
      // hit!
      starHit(s);
      s.el.remove(); s.trail.remove(); state.stars.splice(i,1);
      continue;
    }
    // remove off-screen
    if(s.x < -300 || s.x > rect.width+300 || s.y < -300 || s.y > rect.height+300){
      s.el.remove(); s.trail.remove(); state.stars.splice(i,1);
    }
  }
}

/* on hit */
function starHit(star){
  const penaltyPct = star.type.penalty; const lost = Math.max(1, Math.round(state.fuel * penaltyPct));
  state.fuel = Math.max(0, state.fuel - lost);
  // impact visuals: screen shake & flash
  const app = document.getElementById('appRoot');
  app.classList.add('shake'); hitFlash.style.background = 'rgba(255,255,255,0.14)';
  setTimeout(()=> { app.classList.remove('shake'); hitFlash.style.background = 'rgba(255,255,255,0)'; }, 360);
  // floating text near impact point
  const fxRect = fxLayer.getBoundingClientRect();
  spawnFloating(`-${fmt(lost)} fuel`, star.x + fxRect.left, star.y + fxRect.top);
  spawnSparkles(18);
  renderUI();
}

/* spawn floating text helper */
function spawnFloating(text, px, py){
  const layerRect = fxLayer.getBoundingClientRect();
  const el = document.createElement('div'); el.textContent = text; el.style.position='absolute';
  el.style.left = (px - layerRect.left) + 'px'; el.style.top = (py - layerRect.top) + 'px';
  el.style.transform = 'translate(-50%,-50%)'; el.style.color = '#ff9f7a'; el.style.fontWeight='800'; el.style.pointerEvents='none';
  fxLayer.appendChild(el);
  let t = 0; const iv = setInterval(()=>{ t+=16; el.style.top = (py - layerRect.top - t/12) + 'px'; el.style.opacity = 1 - t/900; if(t>900){ clearInterval(iv); el.remove(); } }, 16);
}

/* -----------------------
   FLAME intensity based on clickBurst
   ----------------------- */
function updateFlame(){
  const flames = document.querySelectorAll('.flame');
  const intensity = 1 + Math.min(7, state.clickBurst) * 0.24;
  flames.forEach(f => { f.style.transform = `translateX(-50%) scaleY(${intensity})`; f.style.opacity = Math.min(1, 0.65 + (intensity-1)/1.2); });
}

/* -----------------------
   ROCKET GLIDING (smooth easing)
   ----------------------- */
function initRocket(){
  const rect = sky.getBoundingClientRect();
  state.rocket.x = rect.width/2; state.rocket.y = rect.height*0.72;
  state.rocket.tx = state.rocket.x; state.rocket.ty = state.rocket.y;
  updateRocketDOM();
}
function skyToLocal(e){
  const r = sky.getBoundingClientRect(); let x,y;
  if(e.touches && e.touches[0]){ x=e.touches[0].clientX; y=e.touches[0].clientY; } else { x=e.clientX; y=e.clientY; }
  x -= r.left; y -= r.top; x = Math.max(44, Math.min(r.width-44, x)); y = Math.max(44, Math.min(r.height-44, y));
  return { x,y };
}
sky.addEventListener('click', e=>{ const p = skyToLocal(e); state.rocket.tx = p.x; state.rocket.ty = p.y; });
sky.addEventListener('touchstart', e=>{ const p = skyToLocal(e); state.rocket.tx = p.x; state.rocket.ty = p.y; }, { passive:true });

function updateRocket(dt){
  // easing towards target
  if(state.rocket.tx === null) return;
  const dx = state.rocket.tx - state.rocket.x; const dy = state.rocket.ty - state.rocket.y;
  // eased interpolation
  state.rocket.x += dx * Math.min(1, state.rocket.easing + dt*2.4);
  state.rocket.y += dy * Math.min(1, state.rocket.easing + dt*2.4);
  updateRocketDOM();
}
function updateRocketDOM(){
  const rect = sky.getBoundingClientRect();
  const px = state.rocket.x; const py = state.rocket.y;
  const bottom = rect.height - py;
  rocketWrap.style.left = px + 'px'; rocketWrap.style.bottom = bottom + 'px';
  // tilt based on horizontal velocity (approx)
  const vx = (state.rocket.tx === null) ? 0 : (state.rocket.tx - state.rocket.x);
  const tilt = Math.max(-12, Math.min(12, vx / 24));
  rocketWrap.style.transform = `translateX(-50%) translateY(0) rotate(${tilt}deg)`;
}

/* -----------------------
   INIT / BOOT
   ----------------------- */
document.getElementById('saveBtn').addEventListener('click', save);
document.getElementById('resetBtn').addEventListener('click', ()=>{ if(confirm('Reset progress?')){ localStorage.removeItem('rocket_polished_v1'); location.reload(); }});
prestigeBtn.addEventListener('click', ()=> alert('Prestige unlocked! (placeholder)'));
rocketWrap.addEventListener('click', ()=> doClick(1));
document.addEventListener('keydown', e=>{ if(e.code === 'Space'){ e.preventDefault(); doClick(1); }});

// init visuals & loops
makeStarLayers(); setupNebulaCanvas(); initRocket(); recalc(); renderStore(); renderUI(); load();

state.lastTick = now();
setInterval(tick, 500); setInterval(save, 15000);

/* shooting star update is called by tick -> updateShootingStars */
function updateShootingStars(dt){ updateShootingStarsCore(dt); } // alias

/* small popup */
function spawnPopup(txt){
  const el = document.createElement('div'); el.textContent = txt; el.style.position='absolute'; el.style.left='50%'; el.style.top='28%';
  el.style.transform='translate(-50%,-50%)'; el.style.color='#ffd7b3'; el.style.fontWeight='800'; el.style.pointerEvents='none'; sky.appendChild(el);
  let t=0; const iv=setInterval(()=>{ t+=16; el.style.top = (28 - t/140) + '%'; el.style.opacity = 1 - t/900; if(t>900){ clearInterval(iv); el.remove(); } },16);
}

// small wrapper to allow the star update func earlier
function updateShootingStarsCore(dt){ updateShootingStars(dt); } // already defined

/* welcome */
setTimeout(()=> spawnPopup('Welcome, Commander! Click the sky to glide and dodge hazards.'), 800);

</script>
</body>
</html>
