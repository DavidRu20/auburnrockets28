<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AHS Class of ’28 — Calendar</title>
  <meta name="theme-color" content="#0d6efd" />
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* Page base */
    body { color: var(--text); background: transparent; overflow-x: hidden; }
    #starfield{
      position: fixed; inset: 0; z-index:-1; pointer-events:none; display:block;
    }

    /* ================== LAYOUT (fills page) ================== */
    main{
      display: grid;
      grid-template-columns: clamp(260px, 22vw, 340px) minmax(0, 1fr); /* sidebar | calendar */
      gap: 24px;
      width: min(96vw, 1800px);
      max-width: none;
      margin-inline: auto;
      padding: 24px clamp(12px, 2vw, 28px);
    }

    /* ---------------- Sidebar ---------------- */
    .sidebar{
      position: sticky; top: 96px;
      height: calc(100vh - 120px);
      overflow: auto;
      padding: 16px;
      border-radius: 18px;
      background: rgba(255,255,255,0.05);
      box-shadow: var(--shadow-1);
      width: auto; max-width: 360px;
    }
    :root[data-theme="light"] .sidebar{
      background: var(--panel);
      border: 1px solid var(--border);
    }
    .sidebar h2{ font-size: 1.5rem; margin-bottom: 12px; }
    .countdown-item{
      background: rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 12px;
      margin: 10px 0;
    }
    :root[data-theme="light"] .countdown-item{ background: rgba(0,0,0,.04); }

    /* ---------------- Calendar card ---------------- */
    .calendar-wrap{
      background: rgba(255,255,255,0.05);
      border-radius: 22px;
      padding: clamp(16px, 2.2vw, 28px);
      box-shadow: var(--shadow-1);
    }
    :root[data-theme="light"] .calendar-wrap{
      background: var(--panel);
      border: 1px solid var(--border);
    }

    .calendar-header{
      display: grid;
      grid-template-columns: 44px 1fr 44px;
      align-items: center;
      margin-bottom: 18px;
    }
    .calendar-title{
      text-align: center;
      font-weight: 700;
      font-size: 1.4rem;
      letter-spacing: .3px;
    }
    .nav-btn{
      height: 44px; width: 44px;
      border: 0; border-radius: 12px;
      background: #0d6efd; color: #fff;
      cursor: pointer; font-size: 1.2rem;
    }

    /* ---------------- Month grid ---------------- */
    .calendar-grid{
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr)); /* stretch evenly */
      gap: 14px;
    }
    .day-name{
      text-align:center; font-weight:600; opacity:.9; padding: 6px 0;
    }
    .day{
      background: rgba(255,255,255,0.08);
      border-radius: 16px;
      min-height: clamp(110px, 12vw, 180px);
      padding: 12px;
      display:flex; flex-direction:column;
      transition: transform .15s ease, background .15s ease;
    }
    :root[data-theme="light"] .day{ background: rgba(0,0,0,.04); }
    .day:hover{ transform: scale(1.02); }
    .day.today{ background:#0d6efd; color:#fff; font-weight:700; }
    .day.event{ background: rgba(0,255,255,.18); border:1px solid cyan; }
    .day.break{ background: rgba(255,165,0,.18); border:1px solid orange; }
    .day.half { background: rgba(13,110,253,.18); border:1px solid var(--blue-2); }
    .day.lunch{ outline: 1px dashed rgba(255,255,255,.25); }
    /* optional styles for extra types */
    .day.no-school { background: rgba(255, 80, 80, .18); border:1px solid rgba(255,80,80,.6); }
    .day.holiday   { background: rgba(60, 220, 120, .18); border:1px solid rgba(60,220,120,.6); }

    /* stacked labels inside a day */
    .event-list { margin-top:auto; display:grid; gap:4px; }
    .event-chip {
      font-size:.75rem; opacity:.95;
      padding:3px 6px; border-radius:8px; width:fit-content;
      background: rgba(255,255,255,.09);
    }
    .day.today .event-chip { background: rgba(0,0,0,.18); }

    .empty{ background: transparent !important; border:0; }

    /* ---------------- Mobile stack ---------------- */
    @media (max-width: 900px){
      main{ grid-template-columns: 1fr; gap: 16px; padding: 16px; width: 100%; }
      .sidebar{ position: static; height:auto; max-width:none; }
      .calendar-grid{ grid-template-columns: repeat(7, minmax(0,1fr)); gap: 8px; }
      .day{ min-height: clamp(80px, 12vw, 120px); padding: 8px; }
    }
  </style>
</head>
<body>
  <!-- starry background -->
  <canvas id="starfield" aria-hidden="true"></canvas>

  <!-- ================= Header / Nav ================= -->
 <header class="header" role="banner">
  <nav class="nav" aria-label="Primary">
    <a class="brand" href="./" aria-label="AHS Class of 2028 — Home">
      <span class="logo" aria-hidden="true">A</span>
      AHS Class of ’28
    </a>

    <!-- Desktop links -->
    <div class="links" role="navigation">
      <a href="./index.html">Home</a>
      <a href="./fundraisers.html">Fundraisers</a>
      <a class="active" href="./calendar.html">Calendar</a>
      <a href="./media.html">Media</a>
      <a href="./achievements.html">Achievements</a>
      <a href="./about.html">About</a>
      <a href="./contact.html">Contact</a>
      <a href="./shop.html">Shop</a>
      <a href="./announcements.html">Announcements</a>
      <a href="./community.html">Community</a>
    </div>

    <!-- Mobile menu button -->
    <button id="menuBtn" class="menu-btn" aria-expanded="false"
            aria-controls="mobileMenu" aria-label="Open menu">☰</button>
  </nav>

  <!-- Mobile menu -->
  <div id="mobileMenu" class="mobile-menu hidden" role="dialog" aria-modal="true" aria-label="Mobile navigation">
    <a href="./index.html">Home</a>
    <a href="./fundraisers.html">Fundraisers</a>
    <a href="./calendar.html">Calendar</a>
    <a href="./media.html">Media</a>
    <a class="active" href="./achievements.html">Achievements</a>
    <a href="./about.html">About</a>
    <a href="./contact.html">Contact</a>
    <a href="./shop.html">Shop</a>
    <a href="./announcements.html">Announcements</a>
    <a href="./community.html">Community</a>
    <div class="small" style="padding:8px 10px; opacity:.8">Tap outside to close</div>
  </div>
</header>


  <!-- ================= Main ================= -->
  <main>
    <aside class="sidebar" id="holidayCountdowns">
      <h2>Upcoming Holidays</h2>
      <!-- items injected by JS -->
    </aside>

    <section class="calendar-wrap">
      <div class="calendar-header">
        <button id="prevMonth" class="nav-btn" type="button" aria-label="Previous month">‹</button>
        <h2 id="calendarMonth" class="calendar-title" aria-live="polite">Loading…</h2>
        <button id="nextMonth" class="nav-btn" type="button" aria-label="Next month">›</button>
      </div>

      <div class="calendar-grid" id="calendarGrid">
        <div class="day-name">Sun</div><div class="day-name">Mon</div><div class="day-name">Tue</div>
        <div class="day-name">Wed</div><div class="day-name">Thu</div><div class="day-name">Fri</div><div class="day-name">Sat</div>
        <!-- days injected by JS -->
      </div>
    </section>
  </main>

  <script>
    /* Mobile menu */
    (function(){
      const btn = document.getElementById('menuBtn');
      const menu = document.getElementById('mobileMenu');
      if (!btn || !menu) return;
      btn.addEventListener('click', e=>{
        e.stopPropagation();
        const hidden = menu.classList.toggle('hidden');
        btn.setAttribute('aria-expanded', String(!hidden));
      });
      document.addEventListener('click', e=>{
        if (!menu.classList.contains('hidden') && !menu.contains(e.target) && e.target !== btn){
          btn.setAttribute('aria-expanded','false'); menu.classList.add('hidden');
        }
      });
    })();

    /* ========= STARFIELD (parallax + twinkle; theme-aware) ========= */
    (function(){
      const canvas = document.getElementById('starfield');
      const ctx = canvas.getContext('2d', { alpha:true });
      const prefersReduce = matchMedia('(prefers-reduced-motion: reduce)').matches;
      let w=0,h=0, stars=[], raf=0, last=performance.now();

      const LAYERS = [
        { n:70,  spd:0.03, size:[0.6,1.2], a:[0.10,0.20] }, // far
        { n:40,  spd:0.06, size:[0.8,1.6], a:[0.12,0.26] }, // mid
        { n:18,  spd:0.10, size:[1.2,2.4], a:[0.16,0.32] }  // near
      ];
      const rnd = (min,max)=> min + Math.random()*(max-min);

      function theme(){
        const light = document.documentElement.getAttribute('data-theme') === 'light';
        return {
          bgTop: light ? '#eaf2ff' : '#05070d',
          bgMid: light ? '#f7fbff' : '#0a0f1b',
          bgBot: light ? '#ffffff' : '#05070d',
          star:  light ? '#6a86b8' : '#e8f1ff'
        };
      }

      function resize(){
        const dpr = devicePixelRatio || 1;
        canvas.width  = Math.floor(innerWidth * dpr);
        canvas.height = Math.floor(innerHeight * dpr);
        canvas.style.width = '100%'; canvas.style.height = '100%';
        ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);
        w = innerWidth; h = innerHeight;

        stars = [];
        LAYERS.forEach((L,li)=>{
          for(let i=0;i<L.n;i++){
            stars.push({
              x: Math.random()*w, y: Math.random()*h,
              r: rnd(L.size[0], L.size[1]),
              a: rnd(L.a[0], L.a[1]),
              tw: rnd(0, Math.PI*2),
              spd: L.spd, layer: li
            });
          }
        });
        paint(true);
      }

      function paint(staticOnly=false){
        const c = theme();
        const g = ctx.createLinearGradient(0,0,0,h);
        g.addColorStop(0,c.bgTop); g.addColorStop(.5,c.bgMid); g.addColorStop(1,c.bgBot);
        ctx.fillStyle = g; ctx.fillRect(0,0,w,h);

        for(const s of stars){
          s.tw += .8 * (staticOnly?0:1/60);
          const tw = 0.5 + 0.5 * Math.sin(s.tw + s.layer);
          const alpha = Math.max(.08, Math.min(1, s.a * (0.85 + 0.25 * tw)));
          ctx.globalAlpha = alpha;
          ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
          ctx.fillStyle = c.star; ctx.fill();
        }
        ctx.globalAlpha = 1;
      }

      function tick(ts){
        const dt = Math.min(.05, (ts - last)/1000); last = ts;
        for(const s of stars){
          s.x += s.spd * 24 * dt;
          s.y += s.spd *  6 * dt;
          if (s.x > w+2) s.x = -2;
          if (s.y > h+2) s.y = -2;
        }
        paint();
        raf = requestAnimationFrame(tick);
      }

      resize();
      addEventListener('resize', resize);
      // re-draw when theme toggles
      const mo = new MutationObserver(resize);
      mo.observe(document.documentElement, { attributes:true, attributeFilter:['data-theme'] });

      if (!prefersReduce){
        raf = requestAnimationFrame(tick);
        document.addEventListener('visibilitychange', ()=> {
          if (document.hidden) cancelAnimationFrame(raf);
          else { last = performance.now(); raf = requestAnimationFrame(tick); }
        });
      } else {
        paint(true);
      }
    })();

    /* ====== EVENTS: robust loader (array OR object JSON) ====== */
    // Make sure this matches your real file path & name:
    const EVENTS_URL = 'data/calendar.json'; // ← fixed filename

    // eventsByDate: { "YYYY-MM-DD": [ {type,label}, ... ] }
    let eventsByDate = {};

    function groupEvents(list){
      const by = {};
      for (const e of list){
        if (!e || !e.date) continue;
        if (!by[e.date]) by[e.date] = [];
        by[e.date].push({ type: (e.type || 'event'), label: (e.label || '') });
      }
      return by;
    }

    // Accept array OR object-shaped JSON
    function normalizeEvents(input){
      if (Array.isArray(input)) return input;

      const out = [];
      if (input && typeof input === 'object'){
        for (const [date, value] of Object.entries(input)){
          if (Array.isArray(value)){
            for (const v of value){
              if (v && typeof v === 'object') out.push({ date, ...v });
            }
          } else if (value && typeof value === 'object'){
            out.push({ date, ...value });
          } else if (value != null){
            out.push({ date, type: 'event', label: String(value) });
          }
        }
      }
      return out;
    }

    /* ====== CALENDAR RENDER ====== */
    (function(){
      const grid = document.getElementById("calendarGrid");
      const monthLabel = document.getElementById("calendarMonth");
      const prevBtn = document.getElementById("prevMonth");
      const nextBtn = document.getElementById("nextMonth");
      let current = new Date();

      function render(date){
        const y = date.getFullYear(), m = date.getMonth();
        monthLabel.textContent = date.toLocaleString("default", { month:"long", year:"numeric" });

        // clear old cells
        grid.querySelectorAll(".day").forEach(el => el.remove());

        const first = new Date(y,m,1), last = new Date(y,m+1,0);
        const start = first.getDay(), total = last.getDate();

        for(let i=0;i<start;i++){
          const e = document.createElement("div"); e.className="day empty"; grid.appendChild(e);
        }

        const today = new Date(); today.setHours(0,0,0,0);

        for(let d=1; d<=total; d++){
          const cell = document.createElement("div");
          cell.className = "day";
          cell.setAttribute('aria-label', `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`);
          cell.textContent = d;

          const key = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          const items = eventsByDate[key] || [];
          if (items.length){
            // choose a primary style for the day
            const priority = { "no-school": 5, holiday:4, event:3, break:2, half:1, lunch:0 };
            const primary = items.slice().sort((a,b)=>(priority[b.type]||0)-(priority[a.type]||0))[0];
            if (primary?.type) cell.classList.add(primary.type);

            // stack labels
            const list = document.createElement('div');
            list.className = 'event-list';
            items.forEach(it => {
              const chip = document.createElement('div');
              chip.className = 'event-chip';
              chip.textContent = it.label || '';
              list.appendChild(chip);
            });
            cell.appendChild(list);
          }

          const thisDay = new Date(y,m,d); thisDay.setHours(0,0,0,0);
          if (+thisDay === +today) cell.classList.add("today");

          grid.appendChild(cell);
        }
      }

      prevBtn.addEventListener("click", ()=>{ current.setMonth(current.getMonth()-1); render(current); });
      nextBtn.addEventListener("click", ()=>{ current.setMonth(current.getMonth()+1); render(current); });

      // Load JSON, then draw
      fetch(EVENTS_URL, { cache:'no-store' })
        .then(r => {
          if (!r.ok) throw new Error(`Fetch failed: ${r.status} ${r.statusText}`);
          return r.json();
        })
        .then(raw => {
          const list = normalizeEvents(raw);
          eventsByDate = groupEvents(list);
          console.log('[Calendar] Loaded', list.length, 'events');
        })
        .catch(err => {
          console.error('[Calendar] Event load error:', err);
          eventsByDate = {};
        })
        .finally(()=>{ render(current); });
    })();

    /* ====== SIDEBAR COUNTDOWNS (holidays only) ====== */
    (function () {
      const wrap = document.getElementById("holidayCountdowns");
      const HOLIDAY_TYPES = new Set(["break", "holiday", "half", "no-school"]); // no lunches

      function startOfToday() { const d = new Date(); d.setHours(0,0,0,0); return d; }
      function fmtDiff(ms) {
        const days  = Math.floor(ms / (1000*60*60*24));
        const hours = Math.floor((ms % (1000*60*60*24)) / (1000*60*60));
        return `${days} days, ${hours} hours`;
      }

      function update() {
        // wipe previous items (keep heading)
        wrap.querySelectorAll(".countdown-item").forEach(n => n.remove());

        const today0 = startOfToday();
        const upcoming = [];

        // read from eventsByDate
        for (const [iso, list] of Object.entries(eventsByDate || {})) {
          const arr = Array.isArray(list) ? list : [list];
          for (const ev of arr) {
            if (!ev || !ev.type) continue;
            if (!HOLIDAY_TYPES.has(ev.type)) continue; // hide lunch/others
            const dt = new Date(iso);
            if (dt >= today0) upcoming.push({ date: dt, label: ev.label, type: ev.type, iso });
          }
        }

        // group per-day
        const byDay = new Map();
        for (const e of upcoming) {
          if (!byDay.has(e.iso)) byDay.set(e.iso, []);
          byDay.get(e.iso).push(e);
        }

        const rows = [...byDay.entries()]
          .map(([iso, items]) => ({ iso, date: items[0].date, items }))
          .sort((a,b) => a.date - b.date)
          .slice(0, 8);

        if (!rows.length) {
          const none = document.createElement("div");
          none.className = "countdown-item";
          none.textContent = "No upcoming holidays found.";
          wrap.appendChild(none);
          return;
        }

        for (const row of rows) {
          const diff = row.date - new Date();
          const item = document.createElement("div");
          item.className = "countdown-item";
          const labels = row.items.map(i => i.label).join(", ");
          item.innerHTML = `
            <div style="font-weight:700;">${labels}</div>
            <div style="opacity:.8">${fmtDiff(diff)}</div>
          `;
          wrap.appendChild(item);
        }
      }

      // call after events load (wait until we actually have events or we at least rendered once)
      const ready = setInterval(() => {
        if (eventsByDate) {
          update();
          clearInterval(ready);
        }
      }, 300);
      setInterval(update, 60*1000);
    })();
  </script>

  <script src="script.js?v=23"></script>
</body>
</html>


