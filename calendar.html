<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AHS Class of ’28 — Calendar</title>
  <meta name="theme-color" content="#0d6efd" />
  <link rel="stylesheet" href="styles.css?v=24" />

  <style>
    /* --- Global header hardening (prevents Community from wrapping) --- */
    .nav{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .links{ display:flex; align-items:center; gap:16px; flex-wrap:nowrap; white-space:nowrap; }
    .mobile-menu{ z-index:1000; }
    .hidden{ display:none !important; }

    /* Page base */
    body { color: var(--text); background: transparent; overflow-x: hidden; }
    #starfield{ position: fixed; inset: 0; z-index:-1; pointer-events:none; display:block; }

    /* ================== LAYOUT (fills page) ================== */
    main{
      display: grid;
      grid-template-columns: clamp(260px, 22vw, 340px) minmax(0, 1fr); /* sidebar | calendar */
      gap: 24px;
      width: min(96vw, 1800px);
      max-width: none;
      margin-inline: auto;
      padding: 24px clamp(12px, 2vw, 28px);
    }

    /* ---------------- Sidebar ---------------- */
    .sidebar{
      position: sticky; top: 96px;
      height: calc(100vh - 120px);
      overflow: auto;
      padding: 16px;
      border-radius: 18px;
      background: rgba(255,255,255,0.05);
      box-shadow: var(--shadow-1);
      width: auto; max-width: 360px;
    }
    :root[data-theme="light"] .sidebar{
      background: var(--panel);
      border: 1px solid var(--border);
    }
    .sidebar h2{ font-size: 1.5rem; margin-bottom: 12px; }
    .countdown-item{
      background: rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 12px;
      margin: 10px 0;
    }
    :root[data-theme="light"] .countdown-item{ background: rgba(0,0,0,.04); }

    /* ---------------- Calendar card ---------------- */
    .calendar-wrap{
      background: rgba(255,255,255,0.05);
      border-radius: 22px;
      padding: clamp(16px, 2.2vw, 28px);
      box-shadow: var(--shadow-1);
    }
    :root[data-theme="light"] .calendar-wrap{
      background: var(--panel);
      border: 1px solid var(--border);
    }

    .calendar-header{
      display: grid;
      grid-template-columns: 44px 1fr 44px;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .calendar-title{
      text-align: center;
      font-weight: 700;
      font-size: 1.4rem;
      letter-spacing: .3px;
    }
    .nav-btn{
      height: 44px; width: 44px;
      border: 0; border-radius: 12px;
      background: #0d6efd; color: #fff;
      cursor: pointer; font-size: 1.2rem;
    }

    /* -------- Toolbar (Search + Type filters) -------- */
    .toolbar{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      margin: 8px 0 18px;
    }
    .search{ flex:1; min-width: 220px; }
    .search input{
      width:100%; padding:10px 12px; border:1px solid var(--border);
      border-radius:12px; background:var(--panel); color:var(--text);
    }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      padding:6px 10px; border:1px solid var(--border); border-radius:999px;
      background:var(--panel); color:var(--muted); font-weight:700; cursor:pointer;
      user-select:none;
      transition: transform var(--t-base), background var(--t-base), color var(--t-base);
    }
    .chip[aria-pressed="true"]{
      background: linear-gradient(135deg,#0d6efd,#2b8cff);
      color:#fff; border-color: transparent;
    }
    .clear-btn{ height: 36px; padding: 0 12px; }

    /* ---------------- Month grid ---------------- */
    .calendar-grid{
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr)); /* stretch evenly */
      gap: 14px;
    }
    .day-name{
      text-align:center; font-weight:600; opacity:.9; padding: 6px 0;
    }
    .day{
      background: rgba(255,255,255,0.08);
      border-radius: 16px;
      min-height: clamp(110px, 12vw, 180px);
      padding: 12px;
      display:flex; flex-direction:column;
      transition: transform .15s ease, background .15s ease;
    }
    :root[data-theme="light"] .day{ background: rgba(0,0,0,.04); }
    .day:hover{ transform: scale(1.02); }
    .day.today{ background:#0d6efd; color:#fff; font-weight:700; }
    .day.event{ background: rgba(0,255,255,.18); border:1px solid cyan; }
    .day.break{ background: rgba(255,165,0,.18); border:1px solid orange; }
    .day.half { background: rgba(13,110,253,.18); border:1px solid var(--blue-2); }
    .day.lunch{ outline: 1px dashed rgba(255,255,255,.25); }
    .day.no-school { background: rgba(255, 80, 80, .18); border:1px solid rgba(255,80,80,.6); }
    .day.holiday   { background: rgba(60, 220, 120, .18); border:1px solid rgba(60,220,120,.6); }

    .event-list { margin-top:auto; display:grid; gap:4px; }
    .event-chip {
      font-size:.75rem; opacity:.95;
      padding:3px 6px; border-radius:8px; width:fit-content;
      background: rgba(255,255,255,.09);
    }
    .day.today .event-chip { background: rgba(0,0,0,.18); }

    .empty{ background: transparent !important; border:0; }

    /* ---------------- Mobile stack ---------------- */
    @media (max-width: 900px){
      main{ grid-template-columns: 1fr; gap: 16px; padding: 16px; width: 100%; }
      .sidebar{ position: static; height:auto; max-width:none; }
      .calendar-grid{ grid-template-columns: repeat(7, minmax(0,1fr)); gap: 8px; }
      .day{ min-height: clamp(80px, 12vw, 120px); padding: 8px; }
    }
  </style>
</head>
<body>
  <canvas id="starfield"></canvas>

  <!-- ================= Header / Nav ================= -->
  <header class="header" role="banner">
    <nav class="nav" aria-label="Primary">
      <a class="brand" href="./" aria-label="AHS Class of 2028 — Home">
        <span class="logo" aria-hidden="true">A</span>
        AHS Class of ’28
      </a>

      <div class="links" role="navigation">
        <a href="./index.html">Home</a>
        <a href="./fundraisers.html">Fundraisers</a>
        <a class="active" href="./calendar.html">Calendar</a>
        <a href="./media.html">Media</a>
        <a href="./achievements.html">Achievements</a>
        <a href="./about.html">About</a>
        <a href="./contact.html">Contact</a>
        <a href="./shop.html">Shop</a>
        <a href="./announcements.html">Announcements</a>
        <a href="./community.html">Community</a>
      </div>

      <button id="menuBtn" class="menu-btn" aria-expanded="false"
              aria-controls="mobileMenu" aria-label="Open menu">☰</button>
    </nav>

    <div id="mobileMenu" class="mobile-menu hidden" role="dialog" aria-modal="true" aria-label="Mobile navigation">
      <a href="./index.html">Home</a>
      <a href="./fundraisers.html">Fundraisers</a>
      <a class="active" href="./calendar.html">Calendar</a>
      <a href="./media.html">Media</a>
      <a href="./achievements.html">Achievements</a>
      <a href="./about.html">About</a>
      <a href="./contact.html">Contact</a>
      <a href="./shop.html">Shop</a>
      <a href="./announcements.html">Announcements</a>
      <a href="./community.html">Community</a>
      <div class="small" style="padding:8px 10px; opacity:.8">Tap outside to close</div>
    </div>
  </header>

  <!-- ================= Main ================= -->
  <main>
    <aside class="sidebar" id="holidayCountdowns">
      <h2>Upcoming Holidays</h2>
      <!-- items injected by JS -->
    </aside>

    <section class="calendar-wrap">
      <div class="calendar-header">
        <button id="prevMonth" class="nav-btn" type="button" aria-label="Previous month">‹</button>
        <h2 id="calendarMonth" class="calendar-title" aria-live="polite">Loading…</h2>
        <button id="nextMonth" class="nav-btn" type="button" aria-label="Next month">›</button>
      </div>

      <!-- Toolbar: search + type filters -->
      <div class="toolbar" role="region" aria-label="Calendar filters">
        <div class="search">
          <input id="searchBox" type="search" placeholder="Search events (e.g., pizza, break, football…)" aria-label="Search events">
        </div>
        <div class="chips" id="typeChips" role="group" aria-label="Filter by type">
          <button class="chip" data-type="event"     aria-pressed="true">Events</button>
          <button class="chip" data-type="sport"     aria-pressed="true">Sports</button>
          <button class="chip" data-type="holiday"   aria-pressed="true">Holidays</button>
          <button class="chip" data-type="break"     aria-pressed="true">Breaks</button>
          <button class="chip" data-type="half"      aria-pressed="true">Half-Days</button>
          <button class="chip" data-type="no-school" aria-pressed="true">No-School</button>
          <button class="chip" data-type="lunch"     aria-pressed="false">Lunch</button>
        </div>
        <button id="clearFilters" class="btn clear-btn">Clear</button>
      </div>

      <div class="calendar-grid" id="calendarGrid">
        <div class="day-name">Sun</div><div class="day-name">Mon</div><div class="day-name">Tue</div>
        <div class="day-name">Wed</div><div class="day-name">Thu</div><div class="day-name">Fri</div><div class="day-name">Sat</div>
        <!-- days injected by JS -->
      </div>
    </section>
  </main>

  <script>
    /* ===== Universal mobile menu (idempotent & robust) ===== */
    (function initMobileMenu(){
      if (window.__ahsMenuBound) return; 
      window.__ahsMenuBound = true;

      function bind(){
        const btn  = document.getElementById('menuBtn');
        const menu = document.getElementById('mobileMenu');
        if (!btn || !menu) return;

        let open = false;
        const set = (v)=>{
          open = v;
          menu.classList.toggle('hidden', !open);
          btn.setAttribute('aria-expanded', String(open));
        };

        btn.addEventListener('click', (e)=>{ e.stopPropagation(); set(!open); }, {passive:true});
        document.addEventListener('click', (e)=>{
          if (!open) return;
          if (!menu.contains(e.target) && e.target !== btn) set(false);
        });
        document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') set(false); });
        menu.querySelectorAll('a').forEach(a=> a.addEventListener('click', ()=> set(false)));
        window.addEventListener('hashchange', ()=> set(false));
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', bind, {once:true});
      } else {
        bind();
      }
    })();

    /* Starfield (theme-aware) */
    (function(){
      const cvs = document.getElementById('starfield');
      const ctx = cvs.getContext('2d', { alpha: false });
      let stars=[];
      function resize(){
        cvs.width = innerWidth; cvs.height = innerHeight;
        stars = Array.from({length: 220}, ()=>({
          x: Math.random()*cvs.width, y: Math.random()*cvs.height,
          r: Math.random()*1.6, v: Math.random()*0.3+0.05
        }));
      }
      addEventListener('resize', resize); resize();
      (function tick(){
        const isLight = document.documentElement.getAttribute('data-theme')==='light';
        const g = ctx.createLinearGradient(0,0,0,cvs.height);
        if(isLight){ g.addColorStop(0,'#eaf2ff'); g.addColorStop(1,'#ffffff'); }
        else{ g.addColorStop(0,'#0b0e1a'); g.addColorStop(1,'#000'); }
        ctx.fillStyle = g; ctx.fillRect(0,0,cvs.width,cvs.height);
        ctx.fillStyle = isLight ? 'rgba(60,90,140,.85)' : 'rgba(180,200,255,.85)';
        for(const s of stars){
          ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
          s.y+=s.v; if(s.y>cvs.height){ s.y=-2; s.x=Math.random()*cvs.width; }
        }
        requestAnimationFrame(tick);
      })();
    })();

    /* ====== EVENTS loader ====== */
    const EVENTS_URL = 'data/calendar-events.json';

    // eventsByDate: { "YYYY-MM-DD": [ {type,label}, ... ] }
    let eventsByDate = {};

    function groupEvents(list){
      const by = {};
      for (const e of list){
        if (!e || !e.date) continue;
        if (!by[e.date]) by[e.date] = [];
        by[e.date].push({ type: (e.type || 'event'), label: (e.label || '') });
      }
      return by;
    }

    function normalizeEvents(input){
      if (Array.isArray(input)) return input;
      const out = [];
      if (input && typeof input === 'object'){
        for (const [date, value] of Object.entries(input)){
          if (Array.isArray(value)){
            for (const v of value){
              if (v && typeof v === 'object') out.push({ date, ...v });
            }
          } else if (value && typeof value === 'object'){
            out.push({ date, ...value });
          } else if (value != null){
            out.push({ date, type: 'event', label: String(value) });
          }
        }
      }
      return out;
    }

    /* ====== FILTER / SEARCH state ====== */
    const activeTypes = new Set(['event','sport','holiday','break','half','no-school']); // lunch off by default
    let query = '';

    function matchesFilters(ev){
      if (!activeTypes.has(ev.type)) return false;
      if (!query) return true;
      return (ev.label || '').toLowerCase().includes(query);
    }

    /* ====== CALENDAR RENDER ====== */
    (function(){
      const grid = document.getElementById("calendarGrid");
      const monthLabel = document.getElementById("calendarMonth");
      const prevBtn = document.getElementById("prevMonth");
      const nextBtn = document.getElementById("nextMonth");

      // Toolbar bindings
      const chipsWrap = document.getElementById('typeChips');
      const searchBox = document.getElementById('searchBox');
      const clearBtn  = document.getElementById('clearFilters');

      chipsWrap.addEventListener('click', (e)=>{
        const btn = e.target.closest('.chip'); if(!btn) return;
        const t = btn.getAttribute('data-type');
        const on = btn.getAttribute('aria-pressed') === 'true';
        if (on) { activeTypes.delete(t); } else { activeTypes.add(t); }
        btn.setAttribute('aria-pressed', String(!on));
        render(current);
      });

      searchBox.addEventListener('input', ()=>{
        query = searchBox.value.trim().toLowerCase();
        render(current);
      });

      clearBtn.addEventListener('click', ()=>{
        ['event','sport','holiday','break','half','no-school','lunch'].forEach(t=>{
          const wantOn = (t !== 'lunch');
          const btn = chipsWrap.querySelector(`[data-type="${t}"]`);
          if (wantOn) activeTypes.add(t); else activeTypes.delete(t);
          if (btn) btn.setAttribute('aria-pressed', String(wantOn));
        });
        searchBox.value = '';
        query = '';
        render(current);
      });

      let current = new Date();

      function render(date){
        const y = date.getFullYear(), m = date.getMonth();
        monthLabel.textContent = date.toLocaleString("default", { month:"long", year:"numeric" });

        // clear old cells
        grid.querySelectorAll(".day:not(.day-name)").forEach(el => el.remove());

        const first = new Date(y,m,1), last = new Date(y,m+1,0);
        const start = first.getDay(), total = last.getDate();

        for(let i=0;i<start;i++){
          const e = document.createElement("div"); e.className="day empty"; grid.appendChild(e);
        }

        const today = new Date(); today.setHours(0,0,0,0);

        for(let d=1; d<=total; d++){
          const cell = document.createElement("div");
          cell.className = "day";
          cell.textContent = d;

          const key = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          const itemsRaw = eventsByDate[key] || [];
          const items = itemsRaw.filter(matchesFilters);

          if (items.length){
            const priority = { "no-school": 5, holiday:4, event:3, break:2, half:1, sport:3, lunch:0 };
            const primary = items.slice().sort((a,b)=>(priority[b.type]||0)-(priority[a.type]||0))[0];
            if (primary?.type) cell.classList.add(primary.type);

            const list = document.createElement('div');
            list.className = 'event-list';
            items.forEach(it => {
              const chip = document.createElement('div');
              chip.className = 'event-chip';
              chip.textContent = it.label || '';
              list.appendChild(chip);
            });
            cell.appendChild(list);
          }

          const thisDay = new Date(y,m,d); thisDay.setHours(0,0,0,0);
          if (+thisDay === +today) cell.classList.add("today");

          grid.appendChild(cell);
        }
      }

      prevBtn.addEventListener("click", ()=>{ current.setMonth(current.getMonth()-1); render(current); });
      nextBtn.addEventListener("click", ()=>{ current.setMonth(current.getMonth()+1); render(current); });

      // Load JSON, then draw
      fetch(EVENTS_URL, { cache:'no-store' })
        .then(r => {
          if (!r.ok) throw new Error(`Fetch failed: ${r.status} ${r.statusText}`);
          return r.json();
        })
        .then(raw => {
          const list = normalizeEvents(raw);
          eventsByDate = groupEvents(list);
          console.log('[Calendar] Loaded', list.length, 'events');
        })
        .catch(err => {
          console.error('[Calendar] Event load error:', err);
          eventsByDate = {};
        })
        .finally(()=>{ render(current); });
    })();

    /* ====== SIDEBAR COUNTDOWNS (holidays only) ====== */
    (function () {
      const wrap = document.getElementById("holidayCountdowns");
      const HOLIDAY_TYPES = new Set(["break", "holiday", "half", "no-school"]); // no lunches

      function startOfToday() { const d = new Date(); d.setHours(0,0,0,0); return d; }
      function fmtDiff(ms) {
        const days  = Math.floor(ms / (1000*60*60*24));
        const hours = Math.floor((ms % (1000*60*60*24)) / (1000*60*60));
        return `${days} days, ${hours} hours`;
      }

      function update() {
        wrap.querySelectorAll(".countdown-item").forEach(n => n.remove());
        const today0 = startOfToday();
        const upcoming = [];

        for (const [iso, list] of Object.entries(eventsByDate || {})) {
          const arr = Array.isArray(list) ? list : [list];
          for (const ev of arr) {
            if (!ev || !ev.type) continue;
            if (!HOLIDAY_TYPES.has(ev.type)) continue;
            const dt = new Date(iso);
            if (dt >= today0) upcoming.push({ date: dt, label: ev.label, type: ev.type, iso });
          }
        }

        const byDay = new Map();
        for (const e of upcoming) {
          if (!byDay.has(e.iso)) byDay.set(e.iso, []);
          byDay.get(e.iso).push(e);
        }

        const rows = [...byDay.entries()]
          .map(([iso, items]) => ({ iso, date: items[0].date, items }))
          .sort((a,b) => a.date - b.date)
          .slice(0, 8);

        if (!rows.length) {
          const none = document.createElement("div");
          none.className = "countdown-item";
          none.textContent = "No upcoming holidays found.";
          wrap.appendChild(none);
          return;
        }

        for (const row of rows) {
          const diff = row.date - new Date();
          const item = document.createElement("div");
          item.className = "countdown-item";
          const labels = row.items.map(i => i.label).join(", ");
          item.innerHTML = `
            <div style="font-weight:700;">${labels}</div>
            <div style="opacity:.8">${fmtDiff(diff)}</div>
          `;
          wrap.appendChild(item);
        }
      }

      const ready = setInterval(() => {
        if (eventsByDate && Object.keys(eventsByDate).length > 0) {
          update();
          clearInterval(ready);
        }
      }, 200);
      setInterval(update, 60*1000);
    })();
  </script>

  <!-- Keep your site JS deferred -->
  <script src="script.js?v=24" defer></script>
</body>
</html>
